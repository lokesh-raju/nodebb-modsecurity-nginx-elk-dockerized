{"version":3,"sources":["public/src/admin/manage/privileges.js"],"names":["define","autocomplete","translator","Benchpress","categorySelector","Privileges","cid","init","isNaN","parseInt","ajaxify","data","selectedCategory","$","category","refreshPrivilegeTable","updateHistory","setupPrivilegeTable","on","checkboxEl","this","privilege","parent","attr","state","prop","rowEl","parents","member","isPrivate","isGroup","undefined","bootbox","confirm","setPrivilege","app","alertError","addUserToPrivilegeTable","addGroupToPrivilegeTable","copyPrivilegesToChildren","groupName","copyPrivilegesFromCategory","copyPrivilegesToAllCategories","exposeAssumedPrivileges","socket","emit","err","privileges","message","tpl","parse","html","translate","privs","each","idx","el","find","push","getAttribute","x","numPrivs","length","inputs","checked","indeterminate","set","replaceWith","modal","dialog","title","show","inputEl","focus","user","ev","ui","defaultPrivileges","url","item","uid","group","name","alertSuccess","categories","slice","fromCid","toCid","refresh"],"mappings":"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","file":"public/src/admin/manage/privileges.js","sourcesContent":["'use strict';\n\ndefine('admin/manage/privileges', [\n\t'autocomplete',\n\t'translator',\n\t'benchpress',\n\t'categorySelector',\n], function (autocomplete, translator, Benchpress, categorySelector) {\n\tvar\tPrivileges = {};\n\n\tvar cid;\n\n\tPrivileges.init = function () {\n\t\tcid = isNaN(parseInt(ajaxify.data.selectedCategory.cid, 10)) ? 'admin' : ajaxify.data.selectedCategory.cid;\n\n\t\tcategorySelector.init($('[component=\"category-selector\"]'), function (category) {\n\t\t\tcid = parseInt(category.cid, 10);\n\t\t\tcid = isNaN(cid) ? 'admin' : cid;\n\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t\tajaxify.updateHistory('admin/manage/privileges/' + (cid || ''));\n\t\t});\n\n\t\tPrivileges.setupPrivilegeTable();\n\t};\n\n\tPrivileges.setupPrivilegeTable = function () {\n\t\t$('.privilege-table-container').on('change', 'input[type=\"checkbox\"]', function () {\n\t\t\tvar checkboxEl = $(this);\n\t\t\tvar privilege = checkboxEl.parent().attr('data-privilege');\n\t\t\tvar state = checkboxEl.prop('checked');\n\t\t\tvar rowEl = checkboxEl.parents('tr');\n\t\t\tvar member = rowEl.attr('data-group-name') || rowEl.attr('data-uid');\n\t\t\tvar isPrivate = parseInt(rowEl.attr('data-private') || 0, 10);\n\t\t\tvar isGroup = rowEl.attr('data-group-name') !== undefined;\n\n\t\t\tif (member) {\n\t\t\t\tif (isGroup && privilege === 'groups:moderate' && !isPrivate && state) {\n\t\t\t\t\tbootbox.confirm('[[admin/manage/categories:alert.confirm-moderate]]', function (confirm) {\n\t\t\t\t\t\tif (confirm) {\n\t\t\t\t\t\t\tPrivileges.setPrivilege(member, privilege, state, checkboxEl);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcheckboxEl.prop('checked', !checkboxEl.prop('checked'));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tPrivileges.setPrivilege(member, privilege, state, checkboxEl);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tapp.alertError('[[error:invalid-data]]');\n\t\t\t}\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.user\"]', Privileges.addUserToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.group\"]', Privileges.addGroupToPrivilegeTable);\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildren\"]', function () {\n\t\t\tPrivileges.copyPrivilegesToChildren(cid, '');\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildrenGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tPrivileges.copyPrivilegesToChildren(cid, groupName);\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFrom\"]', function () {\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, '');\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFromGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, groupName);\n\t\t});\n\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAll\"]', function () {\n\t\t\tPrivileges.copyPrivilegesToAllCategories(cid, '');\n\t\t});\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAllGroup\"]', function () {\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\n\t\t\tPrivileges.copyPrivilegesToAllCategories(cid, groupName);\n\t\t});\n\n\t\tPrivileges.exposeAssumedPrivileges();\n\t};\n\n\tPrivileges.refreshPrivilegeTable = function () {\n\t\tsocket.emit('admin.categories.getPrivilegeSettings', cid, function (err, privileges) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar tpl = parseInt(cid, 10) ? 'admin/partials/privileges/category' : 'admin/partials/privileges/global';\n\t\t\tBenchpress.parse(tpl, {\n\t\t\t\tprivileges: privileges,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\t$('.privilege-table-container').html(html);\n\t\t\t\t\tPrivileges.exposeAssumedPrivileges();\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.exposeAssumedPrivileges = function () {\n\t\t/*\n\t\t\tIf registered-users has a privilege enabled, then all users and groups of that privilege\n\t\t\tshould be assumed to have that privilege as well, even if not set in the db, so reflect\n\t\t\tthis arrangement in the table\n\t\t*/\n\t\tvar privs = [];\n\t\t$('.privilege-table tr[data-group-name=\"registered-users\"] td input[type=\"checkbox\"]').parent().each(function (idx, el) {\n\t\t\tif ($(el).find('input').prop('checked')) {\n\t\t\t\tprivs.push(el.getAttribute('data-privilege'));\n\t\t\t}\n\t\t});\n\t\tfor (var x = 0, numPrivs = privs.length; x < numPrivs; x += 1) {\n\t\t\tvar inputs = $('.privilege-table tr[data-group-name]:not([data-group-name=\"registered-users\"],[data-group-name=\"guests\"],[data-group-name=\"spiders\"]) td[data-privilege=\"' + privs[x] + '\"] input');\n\t\t\tinputs.each(function (idx, el) {\n\t\t\t\tif (!el.checked) {\n\t\t\t\t\tel.indeterminate = true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tPrivileges.setPrivilege = function (member, privilege, state, checkboxEl) {\n\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\tcid: isNaN(cid) ? 0 : cid,\n\t\t\tprivilege: privilege,\n\t\t\tset: state,\n\t\t\tmember: member,\n\t\t}, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tcheckboxEl.replaceWith('<i class=\"fa fa-spin fa-spinner\"></i>');\n\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t});\n\t};\n\n\tPrivileges.addUserToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-user]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.user-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\t\t\tinputEl.focus();\n\n\t\t\tautocomplete.user(inputEl, function (ev, ui) {\n\t\t\t\tvar defaultPrivileges;\n\t\t\t\tif (ajaxify.data.url === '/admin/manage/privileges/admin') {\n\t\t\t\t\tdefaultPrivileges = ['admin:dashboard'];\n\t\t\t\t} else {\n\t\t\t\t\tdefaultPrivileges = cid ? ['find', 'read', 'topics:read'] : ['chat'];\n\t\t\t\t}\n\t\t\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\t\t\tcid: isNaN(cid) ? 0 : cid,\n\t\t\t\t\tprivilege: defaultPrivileges,\n\t\t\t\t\tset: true,\n\t\t\t\t\tmember: ui.item.user.uid,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\n\t\t\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.addGroupToPrivilegeTable = function () {\n\t\tvar modal = bootbox.dialog({\n\t\t\ttitle: '[[admin/manage/categories:alert.find-group]]',\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.group-search]]\" />',\n\t\t\tshow: true,\n\t\t});\n\n\t\tmodal.on('shown.bs.modal', function () {\n\t\t\tvar inputEl = modal.find('input');\n\t\t\tinputEl.focus();\n\n\t\t\tautocomplete.group(inputEl, function (ev, ui) {\n\t\t\t\tvar defaultPrivileges;\n\t\t\t\tif (ajaxify.data.url === '/admin/manage/privileges/admin') {\n\t\t\t\t\tdefaultPrivileges = ['groups:admin:dashboard'];\n\t\t\t\t} else {\n\t\t\t\t\tdefaultPrivileges = cid ? ['groups:find', 'groups:read', 'groups:topics:read'] : ['groups:chat'];\n\t\t\t\t}\n\n\t\t\t\tsocket.emit('admin.categories.setPrivilege', {\n\t\t\t\t\tcid: isNaN(cid) ? 0 : cid,\n\t\t\t\t\tprivilege: defaultPrivileges,\n\t\t\t\t\tset: true,\n\t\t\t\t\tmember: ui.item.group.name,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\n\t\t\t\t\tPrivileges.refreshPrivilegeTable();\n\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesToChildren = function (cid, group) {\n\t\tsocket.emit('admin.categories.copyPrivilegesToChildren', { cid: cid, group: group }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesFromCategory = function (cid, group) {\n\t\tcategorySelector.modal(ajaxify.data.categories.slice(1), function (fromCid) {\n\t\t\tsocket.emit('admin.categories.copyPrivilegesFrom', { toCid: cid, fromCid: fromCid, group: group }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tajaxify.refresh();\n\t\t\t});\n\t\t});\n\t};\n\n\tPrivileges.copyPrivilegesToAllCategories = function (cid, group) {\n\t\tsocket.emit('admin.categories.copyPrivilegesToAllCategories', { cid: cid, group: group }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\n\t\t});\n\t};\n\n\treturn Privileges;\n});\n"]}