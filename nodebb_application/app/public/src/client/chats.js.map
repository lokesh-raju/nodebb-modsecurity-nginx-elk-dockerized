{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","autocomplete","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","resizeMainWindow","addHotkeys","$","document","ready","window","trigger","scrollToBottom","ajaxify","data","hasOwnProperty","get","focus","addSendHandlers","roomId","addPopoutHandler","addActionHandlers","addMemberHandler","find","addRenameHandler","addLeaveHandler","addScrollHandler","uid","addCharactersLeftHandler","addIPHandler","createAutoComplete","on","switchChat","container","ipEl","this","parent","mid","parents","attr","socket","emit","err","ip","app","alertError","html","text","val","previousUrl","match","go","userslug","openChat","history","one","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","length","message","filter","chatMsg","messageId","parseMessage","currentScrollTop","previousHeight","prepend","timeago","addClass","element","updateRemainingLength","action","getAttribute","inputEl","prepEdit","delete","restore","bind","activeContact","prev","next","e","target","last","lastMid","buttonEl","modal","parse","translate","bootbox","dialog","title","refreshParticipantsList","addKickHandler","searchInput","errorEl","require","user","event","selected","username","item","name","translated","confirm","size","callback","ok","chatLib","close","users","listEl","parseAndTranslate","roomName","buttons","save","label","className","submit","newName","sendEl","which","shiftKey","sendMessage","strategies","options","style","z-index","flex","placement","setup","leave","remove","chat","getModal","roomid","url","self","fetch","config","relative_path","credentials","then","response","json","payload","setActive","pushState","location","protocol","host","console","warn","status","catch","error","appendChatMessage","template","chats","roomEl","recentEl","rooms","lastUser","fromUser","usernames","unread","updateUserStatus","titleEl","viewportHeight","mainWrapper","navWrapper","fromTop","offset","toggleClass","removeClass"],"mappings":"AAAA,aAGAA,OAAO,eACN,aACA,aACA,YACA,qBACA,qBACA,uBACA,aACA,yBACE,SAAUC,EAAYC,EAAYC,EAAWC,EAAaC,EAAQC,EAAUC,EAAYC,GAC1F,IAAIC,GACHC,YAAa,OAGd,IAAIC,EAAa,MAEjBF,EAAMG,KAAO,WACZ,IAAIC,EAAMC,MAAMC,2BAEhB,IAAKN,EAAMC,YAAa,CACvBD,EAAMO,qBACNP,EAAMQ,0BAGPb,EAAYQ,OAEZH,EAAMS,oBACNT,EAAMU,mBAEN,GAAIN,IAAQ,MAAQA,IAAQ,KAAM,CACjCJ,EAAMW,aAGPC,EAAEC,UAAUC,MAAM,WACjBF,EAAEG,QAAQC,QAAQ,qBAAsBJ,EAAE,kBAG3CZ,EAAMC,YAAc,KACpBJ,EAASoB,eAAeL,EAAE,mCAE1BhB,EAAOO,OAEP,GAAIe,QAAQC,KAAKC,eAAe,UAAW,CAC1C5B,EAAW6B,IAAI,cAAcC,UAI/BtB,EAAMS,kBAAoB,WACzBT,EAAMuB,gBAAgBL,QAAQC,KAAKK,OAAQZ,EAAE,eAAgBA,EAAE,8CAC/DZ,EAAMyB,mBACNzB,EAAM0B,kBAAkBlC,EAAW6B,IAAI,iBAAkBH,QAAQC,KAAKK,QACtExB,EAAM2B,iBAAiBT,QAAQC,KAAKK,OAAQhC,EAAW6B,IAAI,iBAAiBO,KAAK,4BACjF5B,EAAM6B,iBAAiBX,QAAQC,KAAKK,OAAQhC,EAAW6B,IAAI,iBAAiBO,KAAK,2BACjF5B,EAAM8B,gBAAgBZ,QAAQC,KAAKK,OAAQhC,EAAW6B,IAAI,iBAAiBO,KAAK,0BAChF5B,EAAM+B,iBAAiBb,QAAQC,KAAKK,OAAQN,QAAQC,KAAKa,IAAKpB,EAAE,kBAChEZ,EAAMiC,yBAAyBrB,EAAE,oCACjCZ,EAAMkC,aAAatB,EAAE,oCACrBZ,EAAMmC,mBAAmBvB,EAAE,6BAE3BA,EAAE,yBAAyBwB,GAAG,QAAS,WACtCpC,EAAMqC,gBAIRrC,EAAMkC,aAAe,SAAUI,GAC9BA,EAAUF,GAAG,QAAS,kBAAmB,WACxC,IAAIG,EAAO3B,EAAE4B,MAAMC,SACnB,IAAIC,EAAMH,EAAKI,QAAQ,cAAcC,KAAK,YAC1CC,OAAOC,KAAK,sBAAuBJ,EAAK,SAAUK,EAAKC,GACtD,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,GAEvBR,EAAKY,KAAKH,QAKbhD,EAAMyB,iBAAmB,WACxBb,EAAE,2BAA2BwB,GAAG,QAAS,WACxC,IAAIgB,EAAO5D,EAAW6B,IAAI,cAAcgC,MACxC,IAAI7B,EAASN,QAAQC,KAAKK,OAE1B,GAAIyB,IAAIK,aAAeL,IAAIK,YAAYC,MAAM,SAAU,CACtDrC,QAAQsC,GAAG,QAAUtC,QAAQC,KAAKsC,SAAW,SAAU,WACtDR,IAAIS,SAASlC,EAAQN,QAAQC,KAAKa,MAChC,UACG,CACNjB,OAAO4C,QAAQH,IAAI,GACnBP,IAAIS,SAASlC,EAAQN,QAAQC,KAAKa,KAGnCpB,EAAEG,QAAQ6C,IAAI,qBAAsB,WACnCpE,EAAW6B,IAAI,cAAcgC,IAAID,QAKpCpD,EAAM+B,iBAAmB,SAAUP,EAAQQ,EAAK6B,GAC/C,IAAIC,EAAU,MACdD,EAAGE,IAAI,UAAU3B,GAAG,SAAU,WAC7B,GAAI0B,EAAS,CACZ,OAGD,IAAIE,GAAOH,EAAG,GAAGI,aAAeJ,EAAGK,UAAY,GAC/C,GAAIL,EAAGM,aAAeH,EAAK,CAC1B,OAEDF,EAAU,KACV,IAAIM,EAAQC,SAASR,EAAGS,SAAS,cAAcC,OAAQ,IACvD1B,OAAOC,KAAK,6BACXtB,OAAQA,EACRQ,IAAKA,EACLoC,MAAOA,GACL,SAAUrB,EAAK5B,GACjB,GAAI4B,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAIyB,SAE3B,IAAKrD,EAAM,CACV2C,EAAU,MACV,OAED3C,EAAOA,EAAKsD,OAAO,SAAUC,GAC5B,OAAQ9D,EAAE,wCAA0C8D,EAAQC,UAAY,MAAMJ,SAE/E,IAAKpD,EAAKoD,OAAQ,CACjBT,EAAU,MACV,OAEDjE,EAAS+E,aAAazD,EAAM,SAAUgC,GACrC,IAAI0B,EAAmBhB,EAAGM,YAC1B,IAAIW,EAAiBjB,EAAG,GAAGI,aAC3Bd,EAAOvC,EAAEuC,GACTU,EAAGkB,QAAQ5B,GACXA,EAAKvB,KAAK,YAAYoD,UACtB7B,EAAKvB,KAAK,4BAA4BqD,SAAS,kBAC/CpB,EAAGM,UAAWN,EAAG,GAAGI,aAAea,EAAkBD,GACrDf,EAAU,aAMd9D,EAAMiC,yBAA2B,SAAUQ,GAC1C,IAAIyC,EAAUzC,EAAOb,KAAK,4BAC1BsD,EAAQ9C,GAAG,qBAAsB,WAChCvC,EAASsF,sBAAsB1C,MAIjCzC,EAAM0B,kBAAoB,SAAUwD,EAAS1D,GAC5C0D,EAAQ9C,GAAG,QAAS,gBAAiB,WACpC,IAAIuC,EAAY/D,EAAE4B,MAAMG,QAAQ,cAAcC,KAAK,YACnD,IAAIwC,EAAS5C,KAAK6C,aAAa,eAE/B,OAAQD,GACP,IAAK,OACJ,IAAIE,EAAU1E,EAAE,iBAAmBY,EAAS,+BAC5C3B,EAAS0F,SAASD,EAASX,EAAWnD,GACtC,MAED,IAAK,SACJ3B,EAAS2F,OAAOb,EAAWnD,GAC3B,MAED,IAAK,UACJ3B,EAAS4F,QAAQd,EAAWnD,GAC5B,UAKJxB,EAAMW,WAAa,WAClBjB,EAAUgG,KAAK,UAAW,WACzB,IAAIC,EAAgB/E,EAAE,wBACtB,IAAIgF,EAAOD,EAAcC,OAEzB,GAAIA,EAAKrB,OAAQ,CAChBvE,EAAMqC,WAAWuD,EAAKhD,KAAK,mBAG7BlD,EAAUgG,KAAK,YAAa,WAC3B,IAAIC,EAAgB/E,EAAE,wBACtB,IAAIiF,EAAOF,EAAcE,OAEzB,GAAIA,EAAKtB,OAAQ,CAChBvE,EAAMqC,WAAWwD,EAAKjD,KAAK,mBAG7BlD,EAAUgG,KAAK,KAAM,SAAUI,GAC9B,GAAIA,EAAEC,SAAWvG,EAAW6B,IAAI,cAAcA,IAAI,GAAI,CAErD,IAAImD,EAAUhF,EAAW6B,IAAI,iBAAiBO,KAAK,gCAAgCoE,OACnF,IAAKxB,EAAQD,OAAQ,CACpB,OAED,IAAI0B,EAAUzB,EAAQ5B,KAAK,YAC3B,IAAI0C,EAAU9F,EAAW6B,IAAI,cAE7BxB,EAAS0F,SAASD,EAASW,EAAS/E,QAAQC,KAAKK,YAKpDxB,EAAM2B,iBAAmB,SAAUH,EAAQ0E,GAC1C,IAAIC,EAEJD,EAAS9D,GAAG,QAAS,WACpBtC,EAAWsG,MAAM,iCAAmC,SAAUjD,GAC7D1D,EAAW4G,UAAUlD,EAAM,SAAUA,GACpCgD,EAAQG,QAAQC,QACfC,MAAO,+BACPhC,QAASrB,IAGVgD,EAAMvD,KAAK,YAAa,qBAExB5C,EAAMyG,wBAAwBjF,EAAQ2E,GACtCnG,EAAM0G,eAAelF,EAAQ2E,GAE7B,IAAIQ,EAAcR,EAAMvE,KAAK,SAC7B,IAAIgF,EAAUT,EAAMvE,KAAK,gBACzBiF,SAAS,eAAgB,cAAe,SAAU9G,EAAcN,GAC/DM,EAAa+G,KAAKH,EAAa,SAAUI,EAAOC,GAC/CJ,EAAQxD,KAAK,IACbP,OAAOC,KAAK,+BACXtB,OAAQA,EACRyF,SAAUD,EAASE,KAAKJ,KAAKK,MAC3B,SAAUpE,GACZ,GAAIA,EAAK,CACRtD,EAAW4G,UAAUtD,EAAIyB,QAAS,SAAU4C,GAC3CR,EAAQxD,KAAKgE,KAIfpH,EAAMyG,wBAAwBjF,EAAQ2E,GACtCQ,EAAYtD,IAAI,iBASvBrD,EAAM0G,eAAiB,SAAUlF,EAAQ2E,GACxCA,EAAM/D,GAAG,QAAS,uBAAwB,WACzC,IAAIJ,EAAMqC,SAAS7B,KAAK6C,aAAa,YAAa,IAElDxC,OAAOC,KAAK,oCACXtB,OAAQA,EACRQ,IAAKA,GACH,SAAUe,GACZ,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAIyB,SAG3BxE,EAAMyG,wBAAwBjF,EAAQ2E,QAKzCnG,EAAM8B,gBAAkB,SAAUN,EAAQ0E,GACzCA,EAAS9D,GAAG,QAAS,WACpBkE,QAAQe,SACPC,KAAM,QACNd,MAAO,yBACPhC,QAAS,4FACT+C,SAAU,SAAUC,GACnB,GAAIA,EAAI,CACP3E,OAAOC,KAAK,sBAAuBtB,EAAQ,SAAUuB,GACpD,GAAIA,EAAK,CACRE,IAAIC,WAAWH,EAAIyB,SAIpB,IAAI2B,EAAQD,EAASvD,QAAQ,eAC7B,GAAIwD,EAAM5B,OAAQ,CACjBsC,SAAS,QAAS,SAAUY,GAC3BA,EAAQC,MAAMvB,SAET,CACNjF,QAAQsC,GAAG,mBASlBxD,EAAMyG,wBAA0B,SAAUjF,EAAQ2E,GACjDtD,OAAOC,KAAK,gCAAkCtB,OAAQA,GAAU,SAAUuB,EAAK4E,GAC9E,IAAIC,EAASzB,EAAMvE,KAAK,eAExB,GAAImB,EAAK,CACR,OAAOtD,EAAW4G,UAAU,yBAA0B,SAAUe,GAC/DQ,EAAOhG,KAAK,MAAMwB,KAAKgE,KAIzBnE,IAAI4E,kBAAkB,qCACrBF,MAAOA,GACL,SAAUxE,GACZyE,EAAOzE,KAAKA,QAKfnD,EAAM6B,iBAAmB,SAAUL,EAAQ0E,EAAU4B,GACpD,IAAI3B,EAEJD,EAAS9D,GAAG,QAAS,WACpBtC,EAAWsG,MAAM,+BAChBe,KAAMW,GAAY5G,QAAQC,KAAK2G,UAC7B,SAAU3E,GACZ1D,EAAW4G,UAAUlD,EAAM,SAAUA,GACpCgD,EAAQG,QAAQC,QACfC,MAAO,+BACPhC,QAASrB,EACT4E,SACCC,MACCC,MAAO,kBACPC,UAAW,cACXX,SAAUY,YAQhB,SAASA,IACRtF,OAAOC,KAAK,4BACXtB,OAAQA,EACR4G,QAASjC,EAAMvE,KAAK,aAAayB,OAC/B,SAAUN,GACZ,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAIyB,cAM9BxE,EAAMuB,gBAAkB,SAAUC,EAAQ8D,EAAS+C,GAClD/C,EAAQvB,IAAI,YAAY3B,GAAG,WAAY,SAAU0D,GAChD,GAAIA,EAAEwC,QAAU,KAAOxC,EAAEyC,SAAU,CAClC1I,EAAS2I,YAAYhH,EAAQ8D,GAC7B,OAAO,SAIT+C,EAAOtE,IAAI,SAAS3B,GAAG,QAAS,WAC/BvC,EAAS2I,YAAYhH,EAAQ8D,GAC7BA,EAAQhE,QACR,OAAO,SAITtB,EAAMmC,mBAAqB,SAAU+C,GACpC,IAAKA,EAAQX,OAAQ,CACpB,OAGD,IAAIpD,GACH+D,QAASA,EACTuD,cACAC,SACCC,OACCC,UAAW,IACXC,KAAM,EACN7E,IAAK,WAEN8E,UAAW,QAIblI,EAAEG,QAAQC,QAAQ,yBAA0BG,GAC5C,GAAIA,EAAKsH,WAAWlE,OAAQ,CAC3BxE,EAAagJ,MAAM5H,KAIrBnB,EAAMgJ,MAAQ,SAAUnF,GACvB,IAAIrC,EAASqC,EAAGjB,KAAK,eACrBC,OAAOC,KAAK,sBAAuBtB,EAAQ,SAAUuB,GACpD,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAIyB,SAE3B,GAAIH,SAAS7C,EAAQ,MAAQ6C,SAASnD,QAAQC,KAAKK,OAAQ,IAAK,CAC/DN,QAAQsC,GAAG,QAAUtC,QAAQC,KAAKsC,SAAW,cACvC,CACNI,EAAGoF,SAEJpC,SAAS,QAAS,SAAUqC,GAC3B,IAAI/C,EAAQ+C,EAAKC,SAAS3H,GAC1B,GAAI2E,EAAM5B,OAAQ,CACjB2E,EAAKxB,MAAMvB,SAMfnG,EAAMqC,WAAa,SAAU+G,GAE5B,IAAKA,EAAQ,CACZA,EAAS,GAGV,IAAIC,EAAM,QAAUnI,QAAQC,KAAKsC,SAAW,UAAY2F,EACxD,GAAIE,KAAKC,MAAO,CACfA,MAAMC,OAAOC,cAAgB,QAAUJ,GAAOK,YAAa,YACzDC,KAAK,SAAUC,GACf,GAAIA,EAASpC,GAAI,CAChBoC,EAASC,OAAOF,KAAK,SAAUG,GAC9B7G,IAAI4E,kBAAkB,gCAAiCiC,EAAS,SAAU3G,GACzE3D,EAAW6B,IAAI,qBAAqB8B,KAAKA,GACzCA,EAAKvB,KAAK,YAAYoD,UACtBhF,EAAMU,mBACNQ,QAAQC,KAAO2I,EACf9J,EAAM+J,YACN/J,EAAMS,oBACNG,EAAEG,QAAQC,QAAQ,qBAAsBJ,EAAE,gBAC1Cf,EAASoB,eAAeL,EAAE,mCAC1B,GAAI+C,QAAQqG,UAAW,CACtBrG,QAAQqG,WACPX,IAAKA,GACH,KAAMtI,OAAOkJ,SAASC,SAAW,KAAOnJ,OAAOkJ,SAASE,KAAOX,OAAOC,cAAgB,IAAMJ,YAI5F,CACNe,QAAQC,KAAK,qBAAuBT,EAASU,WAG9CC,MAAM,SAAUC,GAChBJ,QAAQC,KAAK,YAAcG,EAAMhG,eAE7B,CACNtD,QAAQsC,GAAG6F,KAIbrJ,EAAMQ,wBAA0B,WAC/BI,EAAEG,QAAQqB,GAAG,SAAUpC,EAAMU,kBAC7BE,EAAEG,QAAQqB,GAAG,2BAA4B,WACxC,GAAIlC,GAAcgB,QAAQC,KAAKK,OAAQ,CACtCqB,OAAOC,KAAK,yBAA0B5B,QAAQC,KAAKK,QACnDtB,EAAa,UAKhBF,EAAMO,mBAAqB,WAC1BsC,OAAOT,GAAG,sBAAuB,SAAUjB,GAC1C,GAAIkD,SAASlD,EAAKK,OAAQ,MAAQ6C,SAASnD,QAAQC,KAAKK,OAAQ,IAAK,CACpEtB,EAAaiB,EAAKmI,OAAS,EAC3BnI,EAAKqD,QAAQ8E,KAAOnI,EAAKmI,KAEzBzJ,EAAS4K,kBAAkB7J,EAAE,gCAAiCO,EAAKqD,cAC7D,GAAItD,QAAQC,KAAKuJ,SAASC,MAAO,CACvC,IAAIC,EAAShK,EAAE,gBAAkBO,EAAKK,OAAS,KAE/C,GAAIoJ,EAAOrG,OAAS,EAAG,CACtBqG,EAAO3F,SAAS,cACV,CACN,IAAI4F,EAAWrL,EAAW6B,IAAI,eAC9BvB,EAAWsG,MAAM,8BAChB0E,OACCtJ,OAAQL,EAAKK,OACbuJ,SAAU5J,EAAKqD,QAAQwG,SACvBC,UAAW9J,EAAKqD,QAAQwG,SAAS/D,SACjCiE,OAAQ,OAEP,SAAU/H,GACZ1D,EAAW4G,UAAUlD,EAAM,SAAUiE,GACpCyD,EAAS9F,QAAQqC,WAOtBvE,OAAOT,GAAG,2BAA4B,SAAUjB,GAC/C8B,IAAIkI,iBAAiBvK,EAAE,0BAA4BO,EAAKa,IAAM,gCAAiCb,EAAKmJ,UAGrGzK,EAASU,qBAETsC,OAAOT,GAAG,yBAA0B,SAAUjB,GAC7C,IAAIyJ,EAASpL,EAAW6B,IAAI,mBAAoBF,EAAKK,QACrD,IAAI4J,EAAUR,EAAOhJ,KAAK,4BAC1BV,QAAQC,KAAK2G,SAAW3G,EAAKiH,QAE7BgD,EAAQhI,KAAKjC,EAAKiH,YAIpBpI,EAAMU,iBAAmB,WACxB,IAAI2K,EAAiBzK,EAAEG,QAAQmD,SAC/B,IAAIoH,EAAc9L,EAAW6B,IAAI,qBACjC,IAAIkK,EAAa/L,EAAW6B,IAAI,oBAChC,IAAImK,EAAU,EACd,GAAIF,EAAY/G,QAAUgH,EAAWhH,OAAQ,CAC5CiH,EAAUF,EAAYG,SAASzH,KAAOuH,EAAWE,SAASzH,IAG3DpD,EAAE,eAAesD,OAAOmH,EAAiBG,EAAU,GAEnDxL,EAAM+J,aAGP/J,EAAM+J,UAAY,WACjB,GAAI7I,QAAQC,KAAKK,OAAQ,CACxBqB,OAAOC,KAAK,yBAA0B5B,QAAQC,KAAKK,QACnDZ,EAAE,iBAAmBM,QAAQC,KAAKK,OAAS,MAAMkK,YAAY,SAAU,OACvE9K,EAAE,2CAA2CU,QAE9CV,EAAE,kBAAkB+K,YAAY,WAChC/K,EAAE,+BAAiCM,QAAQC,KAAKK,OAAS,MAAMyD,SAAS,WAExEzF,EAAW6B,IAAI,oBAAoBuB,KAAK,cAAe1B,QAAQC,KAAKK,OAAS,IAAM,MAIpF,OAAOxB","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n\t'composer/autocomplete',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress, autocomplete) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.resizeMainWindow();\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\t$(document).ready(function () {\n\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t});\n\n\t\tChats.initialised = true;\n\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\t\tChats.addPopoutHandler();\n\t\tChats.addActionHandlers(components.get('chat/messages'), ajaxify.data.roomId);\n\t\tChats.addMemberHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"members\"]'));\n\t\tChats.addRenameHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"rename\"]'));\n\t\tChats.addLeaveHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"leave\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.addIPHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\n\t\t$('[data-action=\"close\"]').on('click', function () {\n\t\t\tChats.switchChat();\n\t\t});\n\t};\n\n\tChats.addIPHandler = function (container) {\n\t\tcontainer.on('click', '.chat-ip-button', function () {\n\t\t\tvar ipEl = $(this).parent();\n\t\t\tvar mid = ipEl.parents('[data-mid]').attr('data-mid');\n\t\t\tsocket.emit('modules.chats.getIP', mid, function (err, ip) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tipEl.html(ip);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addPopoutHandler = function () {\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt(el.children('[data-mid]').length, 10);\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdata = data.filter(function (chatMsg) {\n\t\t\t\t\treturn !$('[component=\"chat/message\"][data-mid=\"' + chatMsg.messageId + '\"]').length;\n\t\t\t\t});\n\t\t\t\tif (!data.length) {\n\t\t\t\t\tloading = false;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (parent) {\n\t\tvar element = parent.find('[component=\"chat/input\"]');\n\t\telement.on('change keyup paste', function () {\n\t\t\tmessages.updateRemainingLength(parent);\n\t\t});\n\t};\n\n\tChats.addActionHandlers = function (element, roomId) {\n\t\telement.on('click', '[data-action]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar action = this.getAttribute('data-action');\n\n\t\t\tswitch (action) {\n\t\t\t\tcase 'edit':\n\t\t\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'delete':\n\t\t\t\t\tmessages.delete(messageId, roomId);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'restore':\n\t\t\t\t\tmessages.restore(messageId, roomId);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tif (!message.length) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addMemberHandler = function (roomId, buttonEl) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/manage_room', {}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.manage-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t});\n\n\t\t\t\t\tmodal.attr('component', 'chat/manage-modal');\n\n\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\tChats.addKickHandler(roomId, modal);\n\n\t\t\t\t\tvar searchInput = modal.find('input');\n\t\t\t\t\tvar errorEl = modal.find('.text-danger');\n\t\t\t\t\trequire(['autocomplete', 'translator'], function (autocomplete, translator) {\n\t\t\t\t\t\tautocomplete.user(searchInput, function (event, selected) {\n\t\t\t\t\t\t\terrorEl.text('');\n\t\t\t\t\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\t\t\t\t\troomId: roomId,\n\t\t\t\t\t\t\t\tusername: selected.item.user.name,\n\t\t\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\ttranslator.translate(err.message, function (translated) {\n\t\t\t\t\t\t\t\t\t\terrorEl.text(translated);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\t\t\t\tsearchInput.val('');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addKickHandler = function (roomId, modal) {\n\t\tmodal.on('click', '[data-action=\"kick\"]', function () {\n\t\t\tvar uid = parseInt(this.getAttribute('data-uid'), 10);\n\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addLeaveHandler = function (roomId, buttonEl) {\n\t\tbuttonEl.on('click', function () {\n\t\t\tbootbox.confirm({\n\t\t\t\tsize: 'small',\n\t\t\t\ttitle: '[[modules:chat.leave]]',\n\t\t\t\tmessage: '<p>[[modules:chat.leave-prompt]]</p><p class=\"help-block\">[[modules:chat.leave-help]]</p>',\n\t\t\t\tcallback: function (ok) {\n\t\t\t\t\tif (ok) {\n\t\t\t\t\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Return user to chats page. If modal, close modal.\n\t\t\t\t\t\t\tvar modal = buttonEl.parents('.chat-modal');\n\t\t\t\t\t\t\tif (modal.length) {\n\t\t\t\t\t\t\t\trequire(['chat'], function (chatLib) {\n\t\t\t\t\t\t\t\t\tchatLib.close(modal);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tajaxify.go('chats');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.refreshParticipantsList = function (roomId, modal) {\n\t\tsocket.emit('modules.chats.getUsersInRoom', { roomId: roomId }, function (err, users) {\n\t\t\tvar listEl = modal.find('.list-group');\n\n\t\t\tif (err) {\n\t\t\t\treturn translator.translate('[[error:invalid-data]]', function (translated) {\n\t\t\t\t\tlistEl.find('li').text(translated);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/manage_room_users', {\n\t\t\t\tusers: users,\n\t\t\t}, function (html) {\n\t\t\t\tlistEl.html(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, buttonEl, roomName) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/rename_room', {\n\t\t\t\tname: roomName || ajaxify.data.roomName,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.rename-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tfunction submit() {\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: modal.find('#roomName').val(),\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tif (!element.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tstyle: {\n\t\t\t\t\t'z-index': 20000,\n\t\t\t\t\tflex: 0,\n\t\t\t\t\ttop: 'inherit',\n\t\t\t\t},\n\t\t\t\tplacement: 'top',\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tautocomplete.setup(data);\n\t\t}\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\t// Allow empty arg for return to chat list/close chat\n\t\tif (!roomid) {\n\t\t\troomid = '';\n\t\t}\n\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\t\t\t\t\t\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t\t\t\t\t\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: url,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/' + url);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.data.template.chats) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tBenchpress.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.addSocketListeners();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar roomEl = components.get('chat/recent/room', data.roomId);\n\t\t\tvar titleEl = roomEl.find('[component=\"chat/title\"]');\n\t\t\tajaxify.data.roomName = data.newName;\n\n\t\t\ttitleEl.text(data.newName);\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar viewportHeight = $(window).height();\n\t\tvar mainWrapper = components.get('chat/main-wrapper');\n\t\tvar navWrapper = components.get('chat/nav-wrapper');\n\t\tvar fromTop = 0;\n\t\tif (mainWrapper.length && navWrapper.length) {\n\t\t\tfromTop = mainWrapper.offset().top || navWrapper.offset().top;\n\t\t}\n\n\t\t$('.chats-full').height(viewportHeight - fromTop - 1);\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('[data-roomid=\"' + ajaxify.data.roomId + '\"]').toggleClass('unread', false);\n\t\t\t$('.expanded-chat [component=\"chat/input\"]').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-info');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-info');\n\n\t\tcomponents.get('chat/nav-wrapper').attr('data-loaded', ajaxify.data.roomId ? '1' : '0');\n\t};\n\n\n\treturn Chats;\n});\n"]}