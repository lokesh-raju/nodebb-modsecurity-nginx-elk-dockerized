{"version":3,"sources":["public/src/client/groups/memberlist.js"],"names":["define","autocomplete","MemberList","searchInterval","groupName","templateName","init","_templateName","ajaxify","data","group","name","handleMemberAdd","handleMemberSearch","handleMemberInfiniteScroll","$","on","modal","bootbox","dialog","title","message","user","find","ev","ui","item","addUserToGroup","callback","done","err","app","alertError","parseAndTranslate","html","prepend","socket","emit","uid","query","this","val","clearInterval","setTimeout","results","users","attr","$this","bottom","scrollHeight","innerHeight","scrollTop","loadMoreMembers","members","after","length","onMembersLoaded","removeAttr","nextStart","filter","append","isOwner"],"mappings":"AAAA,aAGAA,OAAO,2BAA4B,gBAAiB,SAAUC,GAC7D,IAAIC,KACJ,IAAIC,EACJ,IAAIC,EACJ,IAAIC,EAEJH,EAAWI,KAAO,SAAUC,GAC3BF,EAAeE,GAAiB,iBAChCH,EAAYI,QAAQC,KAAKC,MAAMC,KAE/BC,IACAC,IACAC,KAGD,SAASF,IACRG,EAAE,oCAAoCC,GAAG,QAAS,WACjD,IAAIC,EAAQC,QAAQC,QACnBC,MAAO,gCACPC,QAAS,8EAEVpB,EAAaqB,KAAKL,EAAMM,KAAK,SAAU,SAAUC,EAAIC,GACpD,IAAIH,EAAOG,EAAGC,KAAKJ,KACnB,GAAIA,EAAM,CACTK,EAAeL,EAAM,WACpBL,EAAMA,MAAM,eAOjB,SAASU,EAAeL,EAAMM,GAC7B,SAASC,EAAKC,GACb,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,GAEvBG,GAAmBX,GAAO,SAAUY,GACnCnB,EAAE,sCAAsCoB,QAAQD,KAEjDN,IAED,GAAIxB,IAAc,iBAAkB,CACnCgC,OAAOC,KAAK,yBAA0Bf,EAAKgB,KAAMT,OAC3C,CACNO,OAAOC,KAAK,oBAAsBjC,UAAWA,EAAWkC,IAAKhB,EAAKgB,KAAOT,IAI3E,SAAShB,IACRE,EAAE,uCAAuCC,GAAG,QAAS,WACpD,IAAIuB,EAAQxB,EAAEyB,MAAMC,MACpB,GAAItC,EAAgB,CACnBuC,cAAcvC,GACdA,EAAiB,EAGlBA,EAAiBwC,WAAW,WAC3BP,OAAOC,KAAK,wBAA0BjC,UAAWA,EAAWmC,MAAOA,GAAS,SAAUT,EAAKc,GAC1F,GAAId,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIT,SAE3BY,EAAkBW,EAAQC,MAAO,SAAUX,GAC1CnB,EAAE,sCAAsCmB,KAAKA,GAC7CnB,EAAE,gCAAgC+B,KAAK,iBAAkB,SAGzD,OAIL,SAAShC,IACRC,EAAE,sCAAsCC,GAAG,SAAU,WACpD,IAAI+B,EAAQhC,EAAEyB,MACd,IAAIQ,GAAUD,EAAM,GAAGE,aAAeF,EAAMG,eAAiB,GAE7D,GAAIH,EAAMI,YAAcH,IAAWjC,EAAE,uCAAuC0B,MAAO,CAClFW,OAKH,SAASA,IACR,IAAIC,EAAUtC,EAAE,gCAChB,GAAIsC,EAAQP,KAAK,WAAY,CAC5B,OAGDO,EAAQP,KAAK,UAAW,GACxBV,OAAOC,KAAK,0BACXjC,UAAWA,EACXkD,MAAOD,EAAQP,KAAK,mBAClB,SAAUhB,EAAKrB,GACjB,GAAIqB,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIT,SAG3B,GAAIZ,GAAQA,EAAKoC,MAAMU,OAAQ,CAC9BC,EAAgB/C,EAAKoC,MAAO,WAC3BQ,EAAQI,WAAW,WACnBJ,EAAQP,KAAK,iBAAkBrC,EAAKiD,iBAE/B,CACNL,EAAQI,WAAW,cAKtB,SAASD,EAAgBX,EAAOjB,GAC/BiB,EAAQA,EAAMc,OAAO,SAAUrC,GAC9B,OAAQP,EAAE,2CAA6CO,EAAKgB,IAAM,MAAMiB,SAGzEtB,EAAkBY,EAAO,SAAUX,GAClCnB,EAAE,sCAAsC6C,OAAO1B,GAC/CN,MAIF,SAASK,EAAkBY,EAAOjB,GACjCG,IAAIE,kBAAkB5B,EAAc,iBACnCK,OACC2C,QAASR,EACTgB,QAASrD,QAAQC,KAAKC,MAAMmD,UAE3BjC,GAGJ,OAAO1B","file":"public/src/client/groups/memberlist.js","sourcesContent":["'use strict';\n\n\ndefine('forum/groups/memberlist', ['autocomplete'], function (autocomplete) {\n\tvar MemberList = {};\n\tvar searchInterval;\n\tvar groupName;\n\tvar templateName;\n\n\tMemberList.init = function (_templateName) {\n\t\ttemplateName = _templateName || 'groups/details';\n\t\tgroupName = ajaxify.data.group.name;\n\n\t\thandleMemberAdd();\n\t\thandleMemberSearch();\n\t\thandleMemberInfiniteScroll();\n\t};\n\n\tfunction handleMemberAdd() {\n\t\t$('[component=\"groups/members/add\"]').on('click', function () {\n\t\t\tvar modal = bootbox.dialog({\n\t\t\t\ttitle: '[[groups:details.add-member]]',\n\t\t\t\tmessage: '<input class=\"form-control\" type=\"text\" placeholder=\"[[global:search]]\"/>',\n\t\t\t});\n\t\t\tautocomplete.user(modal.find('input'), function (ev, ui) {\n\t\t\t\tvar user = ui.item.user;\n\t\t\t\tif (user) {\n\t\t\t\t\taddUserToGroup(user, function () {\n\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction addUserToGroup(user, callback) {\n\t\tfunction done(err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err);\n\t\t\t}\n\t\t\tparseAndTranslate([user], function (html) {\n\t\t\t\t$('[component=\"groups/members\"] tbody').prepend(html);\n\t\t\t});\n\t\t\tcallback();\n\t\t}\n\t\tif (groupName === 'administrators') {\n\t\t\tsocket.emit('admin.user.makeAdmins', [user.uid], done);\n\t\t} else {\n\t\t\tsocket.emit('groups.addMember', { groupName: groupName, uid: user.uid }, done);\n\t\t}\n\t}\n\n\tfunction handleMemberSearch() {\n\t\t$('[component=\"groups/members/search\"]').on('keyup', function () {\n\t\t\tvar query = $(this).val();\n\t\t\tif (searchInterval) {\n\t\t\t\tclearInterval(searchInterval);\n\t\t\t\tsearchInterval = 0;\n\t\t\t}\n\n\t\t\tsearchInterval = setTimeout(function () {\n\t\t\t\tsocket.emit('groups.searchMembers', { groupName: groupName, query: query }, function (err, results) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tparseAndTranslate(results.users, function (html) {\n\t\t\t\t\t\t$('[component=\"groups/members\"] tbody').html(html);\n\t\t\t\t\t\t$('[component=\"groups/members\"]').attr('data-nextstart', 20);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}, 250);\n\t\t});\n\t}\n\n\tfunction handleMemberInfiniteScroll() {\n\t\t$('[component=\"groups/members\"] tbody').on('scroll', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar bottom = ($this[0].scrollHeight - $this.innerHeight()) * 0.9;\n\n\t\t\tif ($this.scrollTop() > bottom && !$('[component=\"groups/members/search\"]').val()) {\n\t\t\t\tloadMoreMembers();\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction loadMoreMembers() {\n\t\tvar members = $('[component=\"groups/members\"]');\n\t\tif (members.attr('loading')) {\n\t\t\treturn;\n\t\t}\n\n\t\tmembers.attr('loading', 1);\n\t\tsocket.emit('groups.loadMoreMembers', {\n\t\t\tgroupName: groupName,\n\t\t\tafter: members.attr('data-nextstart'),\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (data && data.users.length) {\n\t\t\t\tonMembersLoaded(data.users, function () {\n\t\t\t\t\tmembers.removeAttr('loading');\n\t\t\t\t\tmembers.attr('data-nextstart', data.nextStart);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tmembers.removeAttr('loading');\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction onMembersLoaded(users, callback) {\n\t\tusers = users.filter(function (user) {\n\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\n\t\t});\n\n\t\tparseAndTranslate(users, function (html) {\n\t\t\t$('[component=\"groups/members\"] tbody').append(html);\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction parseAndTranslate(users, callback) {\n\t\tapp.parseAndTranslate(templateName, 'group.members', {\n\t\t\tgroup: {\n\t\t\t\tmembers: users,\n\t\t\t\tisOwner: ajaxify.data.group.isOwner,\n\t\t\t},\n\t\t}, callback);\n\t}\n\n\treturn MemberList;\n});\n"]}