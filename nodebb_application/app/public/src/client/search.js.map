{"version":3,"sources":["public/src/client/search.js"],"names":["define","searchModule","autocomplete","storage","Search","init","searchQuery","$","attr","searchIn","on","updateFormItemVisiblity","val","highlightMatches","off","e","preventDefault","query","getSearchDataFromDOM","handleSavePreferences","enableAutoComplete","fillOutForm","form","searchData","in","term","matchWords","find","by","tagsinput","categories","searchChildren","is","hasTags","replies","repliesFilter","timeFilter","timeRange","sortBy","sortDirection","showAs","window","trigger","data","hide","indexOf","toggleClass","params","utils","disableToType","getSearchPreferences","formData","merge","ajaxify","Array","isArray","forEach","prop","tag","searchDefaultSortBy","isTopic","isPost","parent","escapeHTML","replace","trim","regexStr","split","join","regex","RegExp","escapeRegexChars","each","result","this","nested","after","length","push","append","html","match","p1","nestedEl","i","addClass","setItem","JSON","stringify","app","alertSuccess","removeItem","reset","userEl","confirmKeys","trimValue","user","privileges","siblings","tagEl"],"mappings":"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","file":"public/src/client/search.js","sourcesContent":["'use strict';\n\n\ndefine('forum/search', ['search', 'autocomplete', 'storage'], function (searchModule, autocomplete, storage) {\n\tvar\tSearch = {};\n\n\tSearch.init = function () {\n\t\tvar searchQuery = $('#results').attr('data-search-query');\n\n\t\tvar searchIn = $('#search-in');\n\n\t\tsearchIn.on('change', function () {\n\t\t\tupdateFormItemVisiblity(searchIn.val());\n\t\t});\n\n\t\thighlightMatches(searchQuery);\n\n\t\t$('#advanced-search').off('submit').on('submit', function (e) {\n\t\t\te.preventDefault();\n\t\t\tsearchModule.query(getSearchDataFromDOM(), function () {\n\t\t\t\t$('#search-input').val('');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\thandleSavePreferences();\n\n\t\tenableAutoComplete();\n\n\t\tfillOutForm();\n\t};\n\n\tfunction getSearchDataFromDOM() {\n\t\tvar form = $('#advanced-search');\n\t\tvar searchData = {\n\t\t\tin: $('#search-in').val(),\n\t\t};\n\t\tsearchData.term = $('#search-input').val();\n\t\tif (searchData.in === 'posts' || searchData.in === 'titlesposts' || searchData.in === 'titles') {\n\t\t\tsearchData.matchWords = form.find('#match-words-filter').val();\n\t\t\tsearchData.by = form.find('#posted-by-user').tagsinput('items');\n\t\t\tsearchData.categories = form.find('#posted-in-categories').val();\n\t\t\tsearchData.searchChildren = form.find('#search-children').is(':checked');\n\t\t\tsearchData.hasTags = form.find('#has-tags').tagsinput('items');\n\t\t\tsearchData.replies = form.find('#reply-count').val();\n\t\t\tsearchData.repliesFilter = form.find('#reply-count-filter').val();\n\t\t\tsearchData.timeFilter = form.find('#post-time-filter').val();\n\t\t\tsearchData.timeRange = form.find('#post-time-range').val();\n\t\t\tsearchData.sortBy = form.find('#post-sort-by').val();\n\t\t\tsearchData.sortDirection = form.find('#post-sort-direction').val();\n\t\t\tsearchData.showAs = form.find('#show-as-topics').is(':checked') ? 'topics' : 'posts';\n\t\t}\n\n\t\t$(window).trigger('action:search.getSearchDataFromDOM', {\n\t\t\tform: form,\n\t\t\tdata: searchData,\n\t\t});\n\n\t\treturn searchData;\n\t}\n\n\tfunction updateFormItemVisiblity(searchIn) {\n\t\tvar hide = searchIn.indexOf('posts') === -1 && searchIn.indexOf('titles') === -1;\n\t\t$('.post-search-item').toggleClass('hide', hide);\n\t}\n\n\tfunction fillOutForm() {\n\t\tvar params = utils.params({\n\t\t\tdisableToType: true,\n\t\t});\n\n\t\tvar searchData = searchModule.getSearchPreferences();\n\t\tvar formData = utils.merge(searchData, params);\n\n\t\tif (formData) {\n\t\t\tif (ajaxify.data.term) {\n\t\t\t\t$('#search-input').val(ajaxify.data.term);\n\t\t\t}\n\t\t\tformData.in = formData.in || 'posts';\n\t\t\t$('#search-in').val(formData.in);\n\t\t\tupdateFormItemVisiblity(formData.in);\n\n\t\t\tif (formData.matchWords) {\n\t\t\t\t$('#match-words-filter').val(formData.matchWords);\n\t\t\t}\n\n\t\t\tif (formData.by) {\n\t\t\t\tformData.by = Array.isArray(formData.by) ? formData.by : [formData.by];\n\t\t\t\tformData.by.forEach(function (by) {\n\t\t\t\t\t$('#posted-by-user').tagsinput('add', by);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (formData.categories) {\n\t\t\t\t$('#posted-in-categories').val(formData.categories);\n\t\t\t}\n\n\t\t\tif (formData.searchChildren) {\n\t\t\t\t$('#search-children').prop('checked', true);\n\t\t\t}\n\n\t\t\tif (formData.hasTags) {\n\t\t\t\tformData.hasTags = Array.isArray(formData.hasTags) ? formData.hasTags : [formData.hasTags];\n\t\t\t\tformData.hasTags.forEach(function (tag) {\n\t\t\t\t\t$('#has-tags').tagsinput('add', tag);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (formData.replies) {\n\t\t\t\t$('#reply-count').val(formData.replies);\n\t\t\t\t$('#reply-count-filter').val(formData.repliesFilter);\n\t\t\t}\n\n\t\t\tif (formData.timeRange) {\n\t\t\t\t$('#post-time-range').val(formData.timeRange);\n\t\t\t\t$('#post-time-filter').val(formData.timeFilter);\n\t\t\t}\n\n\t\t\tif (formData.sortBy || ajaxify.data.searchDefaultSortBy) {\n\t\t\t\t$('#post-sort-by').val(formData.sortBy || ajaxify.data.searchDefaultSortBy);\n\t\t\t}\n\t\t\t$('#post-sort-direction').val(formData.sortDirection || 'desc');\n\n\t\t\tif (formData.showAs) {\n\t\t\t\tvar isTopic = formData.showAs === 'topics';\n\t\t\t\tvar isPost = formData.showAs === 'posts';\n\t\t\t\t$('#show-as-topics').prop('checked', isTopic).parent().toggleClass('active', isTopic);\n\t\t\t\t$('#show-as-posts').prop('checked', isPost).parent().toggleClass('active', isPost);\n\t\t\t}\n\n\t\t\t$(window).trigger('action:search.fillOutForm', {\n\t\t\t\tform: formData,\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction highlightMatches(searchQuery) {\n\t\tif (!searchQuery) {\n\t\t\treturn;\n\t\t}\n\t\tsearchQuery = utils.escapeHTML(searchQuery.replace(/^\"/, '').replace(/\"$/, '').trim());\n\t\tvar regexStr = searchQuery.split(' ').join('|');\n\t\tvar regex = new RegExp('(' + utils.escapeRegexChars(regexStr) + ')', 'gi');\n\n\t\t$('.search-result-text p, .search-result-text h4').each(function () {\n\t\t\tvar result = $(this);\n\t\t\tvar nested = [];\n\n\t\t\tresult.find('*').each(function () {\n\t\t\t\t$(this).after('<!-- ' + nested.length + ' -->');\n\t\t\t\tnested.push($('<div></div>').append($(this)));\n\t\t\t});\n\n\t\t\tresult.html(result.html().replace(regex, function (match, p1) {\n\t\t\t\treturn '<strong class=\"search-match\">' + p1 + '</strong>';\n\t\t\t}));\n\n\t\t\tnested.forEach(function (nestedEl, i) {\n\t\t\t\tresult.html(result.html().replace('<!-- ' + i + ' -->', function () {\n\t\t\t\t\treturn nestedEl.html();\n\t\t\t\t}));\n\t\t\t});\n\t\t});\n\n\t\t$('.search-result-text').find('img:not(.not-responsive)').addClass('img-responsive');\n\t}\n\n\tfunction handleSavePreferences() {\n\t\t$('#save-preferences').on('click', function () {\n\t\t\tstorage.setItem('search-preferences', JSON.stringify(getSearchDataFromDOM()));\n\t\t\tapp.alertSuccess('[[search:search-preferences-saved]]');\n\t\t\treturn false;\n\t\t});\n\n\t\t$('#clear-preferences').on('click', function () {\n\t\t\tstorage.removeItem('search-preferences');\n\t\t\tvar query = $('#search-input').val();\n\t\t\t$('#advanced-search')[0].reset();\n\t\t\t$('#search-input').val(query);\n\t\t\tapp.alertSuccess('[[search:search-preferences-cleared]]');\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tfunction enableAutoComplete() {\n\t\tvar userEl = $('#posted-by-user');\n\t\tuserEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\t\tif (app.user.privileges['search:users']) {\n\t\t\tautocomplete.user(userEl.siblings('.bootstrap-tagsinput').find('input'));\n\t\t}\n\n\t\tvar tagEl = $('#has-tags');\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\t\tif (app.user.privileges['search:tags']) {\n\t\t\tautocomplete.tag(tagEl.siblings('.bootstrap-tagsinput').find('input'));\n\t\t}\n\t}\n\n\treturn Search;\n});\n"]}