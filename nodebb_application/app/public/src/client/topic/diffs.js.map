{"version":3,"sources":["public/src/client/topic/diffs.js"],"names":["define","Images","Benchpress","translator","Diffs","open","pid","config","enablePostHistory","localeStringOpts","year","month","day","hour","minute","socket","emit","err","data","app","alertError","message","parse","diffs","revisions","map","revision","timestamp","parseInt","username","pretty","Date","toLocaleString","userLang","replace","numDiffs","timestamps","length","editable","html","translate","modal","bootbox","dialog","title","size","selectEl","find","revertEl","postContainer","on","load","this","value","prop","indexOf","restore","val","since","deleted","parseAndTranslate","posts","empty","append","alertSuccess"],"mappings":"AAAA,aAEAA,OAAO,qBAAsB,qBAAsB,aAAc,cAAe,SAAUC,EAAQC,EAAYC,GAC7G,IAAIC,KAEJA,EAAMC,KAAO,SAAUC,GACtB,IAAKC,OAAOC,kBAAmB,CAC9B,OAGD,IAAIC,GAAqBC,KAAM,UAAWC,MAAO,QAASC,IAAK,UAAWC,KAAM,UAAWC,OAAQ,WAEnGC,OAAOC,KAAK,kBAAoBV,IAAKA,GAAO,SAAUW,EAAKC,GAC1D,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BnB,EAAWoB,MAAM,gCAChBC,MAAOL,EAAKM,UAAUC,IAAI,SAAUC,GACnC,IAAIC,EAAYC,SAASF,EAASC,UAAW,IAE7C,OACCE,SAAUH,EAASG,SACnBF,UAAWA,EACXG,OAAQ,IAAIC,KAAKJ,GAAWK,eAAezB,OAAO0B,SAASC,QAAQ,IAAK,KAAMzB,MAGhF0B,SAAUjB,EAAKkB,WAAWC,OAC1BC,SAAUpB,EAAKoB,UACb,SAAUC,GACZpC,EAAWqC,UAAUD,EAAM,SAAUA,GACpC,IAAIE,EAAQC,QAAQC,QACnBC,MAAO,wBACPvB,QAASkB,EACTM,KAAM,UAGP,IAAK3B,EAAKkB,WAAWC,OAAQ,CAC5B,OAGD,IAAIS,EAAWL,EAAMM,KAAK,UAC1B,IAAIC,EAAWP,EAAMM,KAAK,iCAC1B,IAAIE,EAAgBR,EAAMM,KAAK,iBAE/BD,EAASI,GAAG,SAAU,WACrB9C,EAAM+C,KAAK7C,EAAK8C,KAAKC,MAAOJ,GAC5BD,EAASM,KAAK,WAAYpC,EAAKkB,WAAWmB,QAAQH,KAAKC,SAAW,KAGnEL,EAASE,GAAG,QAAS,WACpB9C,EAAMoD,QAAQlD,EAAKwC,EAASW,MAAOhB,KAGpCA,EAAMS,GAAG,iBAAkB,WAC1B9C,EAAM+C,KAAK7C,EAAKwC,EAASW,MAAOR,GAChCD,EAASM,KAAK,WAAY,eAO/BlD,EAAM+C,KAAO,SAAU7C,EAAKoD,EAAOT,GAClC,IAAK1C,OAAOC,kBAAmB,CAC9B,OAGDO,OAAOC,KAAK,oBAAsBV,IAAKA,EAAKoD,MAAOA,GAAS,SAAUzC,EAAKC,GAC1E,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BH,EAAKyC,UAAY/B,SAASV,EAAKyC,QAAS,IAExCxC,IAAIyC,kBAAkB,sBAAuB,SAC5CC,OAAQ3C,IACN,SAAUqB,GACZU,EAAca,QAAQC,OAAOxB,QAKhCnC,EAAMoD,QAAU,SAAUlD,EAAKoD,EAAOjB,GACrC,IAAKlC,OAAOC,kBAAmB,CAC9B,OAGDO,OAAOC,KAAK,qBAAuBV,IAAKA,EAAKoD,MAAOA,GAAS,SAAUzC,GACtE,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,GAGvBwB,EAAMA,MAAM,QACZtB,IAAI6C,aAAa,oCAInB,OAAO5D","file":"public/src/client/topic/diffs.js","sourcesContent":["'use strict';\n\ndefine('forum/topic/diffs', ['forum/topic/images', 'benchpress', 'translator'], function (Images, Benchpress, translator) {\n\tvar Diffs = {};\n\n\tDiffs.open = function (pid) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar localeStringOpts = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' };\n\n\t\tsocket.emit('posts.getDiffs', { pid: pid }, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tBenchpress.parse('partials/modals/post_history', {\n\t\t\t\tdiffs: data.revisions.map(function (revision) {\n\t\t\t\t\tvar timestamp = parseInt(revision.timestamp, 10);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tusername: revision.username,\n\t\t\t\t\t\ttimestamp: timestamp,\n\t\t\t\t\t\tpretty: new Date(timestamp).toLocaleString(config.userLang.replace('_', '-'), localeStringOpts),\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\tnumDiffs: data.timestamps.length,\n\t\t\t\teditable: data.editable,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tvar modal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[topic:diffs.title]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tsize: 'large',\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!data.timestamps.length) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar selectEl = modal.find('select');\n\t\t\t\t\tvar revertEl = modal.find('button[data-action=\"restore\"]');\n\t\t\t\t\tvar postContainer = modal.find('ul.posts-list');\n\n\t\t\t\t\tselectEl.on('change', function () {\n\t\t\t\t\t\tDiffs.load(pid, this.value, postContainer);\n\t\t\t\t\t\trevertEl.prop('disabled', data.timestamps.indexOf(this.value) === 0);\n\t\t\t\t\t});\n\n\t\t\t\t\trevertEl.on('click', function () {\n\t\t\t\t\t\tDiffs.restore(pid, selectEl.val(), modal);\n\t\t\t\t\t});\n\n\t\t\t\t\tmodal.on('shown.bs.modal', function () {\n\t\t\t\t\t\tDiffs.load(pid, selectEl.val(), postContainer);\n\t\t\t\t\t\trevertEl.prop('disabled', true);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tDiffs.load = function (pid, since, postContainer) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tsocket.emit('posts.showPostAt', { pid: pid, since: since }, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tdata.deleted = !!parseInt(data.deleted, 10);\n\n\t\t\tapp.parseAndTranslate('partials/posts_list', 'posts', {\n\t\t\t\tposts: [data],\n\t\t\t}, function (html) {\n\t\t\t\tpostContainer.empty().append(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tDiffs.restore = function (pid, since, modal) {\n\t\tif (!config.enablePostHistory) {\n\t\t\treturn;\n\t\t}\n\n\t\tsocket.emit('posts.restoreDiff', { pid: pid, since: since }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err);\n\t\t\t}\n\n\t\t\tmodal.modal('hide');\n\t\t\tapp.alertSuccess('[[topic:diffs.post-restored]]');\n\t\t});\n\t};\n\n\treturn Diffs;\n});\n"]}