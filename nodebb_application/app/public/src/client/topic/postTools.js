"use strict";define("forum/topic/postTools",["share","navigator","components","translator","forum/topic/votes"],function(t,o,e,a,n){var i={};var r=false;i.init=function(o){r=false;s();c(o);t.addShareHandlers(ajaxify.data.titleRaw);n.addVoteHandler();i.updatePostCount(ajaxify.data.postcount)};function s(){$('[component="topic"]').on("show.bs.dropdown",".moderator-tools",function(){var t=$(this);var o=t.find(".dropdown-menu");if(o.html()){return}var e=t.parents("[data-pid]");var a=e.attr("data-pid");var n=parseInt(e.attr("data-index"),10);socket.emit("posts.loadPostTools",{pid:a,cid:ajaxify.data.cid},function(t,e){if(t){return app.alertError(t.message)}e.posts.display_move_tools=e.posts.display_move_tools&&n!==0;app.parseAndTranslate("partials/topic/post-menu-list",e,function(t){o.html(t);require(["clipboard"],function(t){new t("[data-clipboard-text]")});$(window).trigger("action:post.tools.load")})})})}i.toggle=function(t,o){var a=e.get("post","pid",t);a.find('[component="post/quote"], [component="post/bookmark"], [component="post/reply"], [component="post/flag"], [component="user/chat"]').toggleClass("hidden",o);a.find('[component="post/delete"]').toggleClass("hidden",o).parent().attr("hidden",o?"":null);a.find('[component="post/restore"]').toggleClass("hidden",!o).parent().attr("hidden",!o?"":null);a.find('[component="post/purge"]').toggleClass("hidden",!o).parent().attr("hidden",!o?"":null);i.removeMenu(a)};i.removeMenu=function(t){t.find('[component="post/tools"] .dropdown-menu').html("")};i.updatePostCount=function(t){var a=e.get("topic/post-count");a.html(t).attr("title",t);utils.makeNumbersHumanReadable(a);o.setCount(t)};function c(t){var o=e.get("topic");o.on("click",'[component="post/quote"]',function(){d($(this),t)});o.on("click",'[component="post/reply"]',function(){p($(this),t)});$(".topic").on("click",'[component="topic/reply"]',function(o){o.preventDefault();p($(this),t)});$(".topic").on("click",'[component="topic/reply-as-topic"]',function(){a.translate("[[topic:link_back, "+ajaxify.data.titleRaw+", "+config.relative_path+"/topic/"+ajaxify.data.slug+"]]",function(t){$(window).trigger("action:composer.topic.new",{cid:ajaxify.data.cid,body:t})})});o.on("click",'[component="post/bookmark"]',function(){return u($(this),f($(this),"data-pid"))});o.on("click",'[component="post/upvote"]',function(){return n.toggleVote($(this),".upvoted","posts.upvote")});o.on("click",'[component="post/downvote"]',function(){return n.toggleVote($(this),".downvoted","posts.downvote")});o.on("click",'[component="post/vote-count"]',function(){n.showVotes(f($(this),"data-pid"))});o.on("click",'[component="post/flag"]',function(){var t=f($(this),"data-pid");require(["flags"],function(o){o.showFlagModal({type:"post",id:t})})});o.on("click",'[component="post/flagUser"]',function(){var t=f($(this),"data-uid");require(["flags"],function(o){o.showFlagModal({type:"user",id:t})})});o.on("click",'[component="post/edit"]',function(){var t=$(this);var o=parseInt(f(t,"data-timestamp"),10);var e=parseInt(ajaxify.data.postEditDuration,10);if(i(e,o,"post-edit-duration-expired")){$(window).trigger("action:composer.post.edit",{pid:f(t,"data-pid")})}});if(config.enablePostHistory&&ajaxify.data.privileges["posts:history"]){o.on("click",'[component="post/view-history"], [component="post/edit-indicator"]',function(){var t=$(this);require(["forum/topic/diffs"],function(o){o.open(f(t,"data-pid"))})})}o.on("click",'[component="post/delete"]',function(){var o=$(this);var e=parseInt(f(o,"data-timestamp"),10);var a=parseInt(ajaxify.data.postDeleteDuration,10);if(i(a,e,"post-delete-duration-expired")){g($(this),t)}});function i(t,o,e){if(!ajaxify.data.privileges.isAdminOrMod&&t&&Date.now()-o>t*1e3){var a=Math.floor(t/86400);var n=Math.floor(t%86400/3600);var i=Math.floor(t%86400%3600/60);var r=t%86400%3600%60;var s="[[error:"+e+", "+t+"]]";if(a){if(n){s="[[error:"+e+"-days-hours, "+a+", "+n+"]]"}else{s="[[error:"+e+"-days, "+a+"]]"}}else if(n){if(i){s="[[error:"+e+"-hours-minutes, "+n+", "+i+"]]"}else{s="[[error:"+e+"-hours, "+n+"]]"}}else if(i){if(r){s="[[error:"+e+"-minutes-seconds, "+i+", "+r+"]]"}else{s="[[error:"+e+"-minutes, "+i+"]]"}}app.alertError(s);return false}return true}o.on("click",'[component="post/restore"]',function(){g($(this),t)});o.on("click",'[component="post/purge"]',function(){v($(this),t)});o.on("click",'[component="post/move"]',function(){var t=$(this);require(["forum/topic/move-post"],function(o){o.init(t.parents("[data-pid]"))})});o.on("click",'[component="post/change-owner"]',function(){var t=$(this);require(["forum/topic/change-owner"],function(o){o.init(t.parents("[data-pid]"))})});o.on("click",'[component="post/ban-ip"]',function(){var t=$(this).attr("data-ip");socket.emit("blacklist.addRule",t,function(t){if(t){return app.alertError(t.message)}app.alertSuccess("[[admin/manage/blacklist:ban-ip]]")})});o.on("click",'[component="post/chat"]',function(){w($(this))})}function p(t,o){var e=l();k(function(){var a=m(t);if(f(t,"data-uid")==="0"||!f(t,"data-userslug")){a=""}var n=t.is('[component="post/reply"]')?f(t,"data-pid"):null;if(e.text&&(!n||!e.pid||n===e.pid)){a=a||e.username;$(window).trigger("action:composer.addQuote",{tid:o,pid:n,topicName:ajaxify.data.titleRaw,username:a,text:e.text,selectedPid:e.pid})}else{$(window).trigger("action:composer.post.new",{tid:o,pid:n,topicName:ajaxify.data.titleRaw,text:a?a+" ":$('[component="topic/quickreply/text"]').val()||""})}})}function d(t,o){var e=l();k(function(){var a=m(t);var n=f(t,"data-pid");function i(t){$(window).trigger("action:composer.addQuote",{tid:o,pid:n,username:a,topicName:ajaxify.data.titleRaw,text:t})}if(e.text&&n&&n===e.pid){return i(e.text)}socket.emit("posts.getRawPost",n,function(t,o){if(t){return app.alertError(t.message)}i(o)})})}function l(){var t="";var o;var e="";var a=window.getSelection?window.getSelection():document.selection.createRange();var n=$('[component="post"] [component="post/content"]');var i;n.each(function(t,o){if(a&&a.containsNode&&o&&a.containsNode(o,true)){i=o}});if(i){var r=document.createRange();r.selectNodeContents(i);var s=a.getRangeAt(0).cloneRange();if(s.compareBoundaryPoints(Range.START_TO_START,r)<0){s.setStart(r.startContainer,r.startOffset)}if(s.compareBoundaryPoints(Range.END_TO_END,r)>0){s.setEnd(r.endContainer,r.endOffset)}r.detach();t=s.toString();var c=$(i).parents('[component="post"]');o=c.attr("data-pid");e=m($(i));s.detach()}return{text:t,pid:o,username:e}}function u(t,o){var e=t.attr("data-bookmarked")==="false"?"posts.bookmark":"posts.unbookmark";socket.emit(e,{pid:o,room_id:"topic_"+ajaxify.data.tid},function(t){if(t){app.alertError(t.message)}});return false}function f(t,o){return t.parents("[data-pid]").attr(o)}function m(t){var o="";var e=t.parents("[data-pid]");if(t.attr("component")==="topic/reply"){return o}if(e.length){o=utils.slugify(e.attr("data-username"),true)}if(e.length&&e.attr("data-uid")!=="0"){o="@"+o}return o}function g(t,o){var a=f(t,"data-pid");var n=e.get("post","pid",a);var i=!n.hasClass("deleted")?"delete":"restore";h(i,a,o)}function v(t,o){h("purge",f(t,"data-pid"),o)}function h(t,o,e){a.translate("[[topic:post_"+t+"_confirm]]",function(a){bootbox.confirm(a,function(a){if(!a){return}socket.emit("posts."+t,{pid:o,tid:e},function(t){if(t){app.alertError(t.message)}})})})}function w(t){var o=t.parents("[data-pid]");app.newChat(o.attr("data-uid"));t.parents(".btn-group").find(".dropdown-toggle").click();return false}function k(t){var o=Math.min(Date.now()-1e3*60*60*24*ajaxify.data.topicStaleDays,864e13);if(r||ajaxify.data.lastposttime>=o){return t()}a.translate("[[topic:stale.warning]]",function(o){var e=bootbox.dialog({title:"[[topic:stale.title]]",message:o,buttons:{reply:{label:"[[topic:stale.reply_anyway]]",className:"btn-link",callback:function(){r=true;t()}},create:{label:"[[topic:stale.create]]",className:"btn-primary",callback:function(){a.translate("[[topic:link_back, "+ajaxify.data.title+", "+config.relative_path+"/topic/"+ajaxify.data.slug+"]]",function(t){$(window).trigger("action:composer.topic.new",{cid:ajaxify.data.cid,body:t})})}}}});e.modal()})}return i});
//# sourceMappingURL=postTools.js.map