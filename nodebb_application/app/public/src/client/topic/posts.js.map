{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","translator","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","updatePostIndices","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","postSharing","deleted","i","cmp","get","html","attr","addCommasToNumbers","topicPostSort","index","not","each","newIndex","$","this","scrollToPost","scrollToPostIfSelf","pageCount","Math","max","ceil","topic","postsPerPage","direction","isPostVisible","currentPage","createNewPosts","scrollToMyPost","setTimeout","loadPage","updatePagination","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","go","pid","addClass","scrollBottom","repliesSelector","callback","removeAlreadyAddedPosts","newPosts","allSamePids","el","removeClass","p","hasClass","filter","before","last","first","slug","window","trigger","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","onNewPostsAddedToDom","loadMorePosts","scrollActive","find","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","onTopicPageLoad","handlePrivateUploads","wrapImagesInLinks","showBottomPostBar","addBlockquoteEllipses","hidePostToolsForDeletedPosts","addNecroPostMessage","necroThreshold","prev","diff","abs","suffixAgo","timeago","settings","strings","prefixAgo","suffixFromNow","prefixFromNow","translationText","inWords","text","prependTo","privateUploads","loginEl","createElement","className","href","translate","translated","appendChild","createTextNode","idx","postEl","imgEl","startsWith","upload_url","replaceWith","cloneNode","createUserTooltips","makeNumbersHumanReadable","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/posts', [\n\t'forum/pagination',\n\t'forum/infinitescroll',\n\t'forum/topic/postTools',\n\t'forum/topic/images',\n\t'navigator',\n\t'components',\n\t'translator',\n], function (pagination, infinitescroll, postTools, images, navigator, components, translator) {\n\tvar Posts = { };\n\n\tPosts.onNewPost = function (data) {\n\t\tif (!data || !data.posts || !data.posts.length || parseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata.loggedIn = !!app.user.uid;\n\t\tdata.privileges = ajaxify.data.privileges;\n\n\t\t// prevent timeago in future by setting timestamp to 1 sec behind now\n\t\tdata.posts[0].timestamp = Date.now() - 1000;\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\n\n\t\tPosts.modifyPostsByPrivileges(data.posts);\n\n\t\tupdatePostCounts(data.posts);\n\n\t\tupdatePostIndices(data.posts);\n\n\t\tajaxify.data.postcount += 1;\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\n\n\t\tif (config.usePagination) {\n\t\t\tonNewPostPagination(data);\n\t\t} else {\n\t\t\tonNewPostInfiniteScroll(data);\n\t\t}\n\n\t\trequire(['forum/topic/replies'], function (replies) {\n\t\t\treplies.onNewPost(data);\n\t\t});\n\t};\n\n\tPosts.modifyPostsByPrivileges = function (posts) {\n\t\tposts.forEach(function (post) {\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod || (post.selfPost && !ajaxify.data.locked) || ((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\n\t\t});\n\t};\n\n\tfunction updatePostCounts(posts) {\n\t\tfor (var i = 0; i < posts.length; i += 1) {\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\n\t\t\tutils.addCommasToNumbers(cmp);\n\t\t}\n\t}\n\n\tfunction updatePostIndices(posts) {\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\n\t\t\tposts[0].index = 1;\n\t\t\tcomponents.get('post').not('[data-index=0]').each(function () {\n\t\t\t\tvar newIndex = parseInt($(this).attr('data-index'), 10) + 1;\n\t\t\t\t$(this).attr('data-index', newIndex);\n\t\t\t});\n\t\t}\n\t}\n\n\tfunction onNewPostPagination(data) {\n\t\tfunction scrollToPost() {\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t}\n\n\t\tvar posts = data.posts;\n\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil(posts[0].topic.postcount / config.postsPerPage));\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\n\n\t\tvar isPostVisible = (ajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount && direction === 1) ||\n\t\t\t\t\t\t\t(ajaxify.data.pagination.currentPage === 1 && direction === -1);\n\n\t\tif (isPostVisible) {\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, scrollToPost);\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\n\t\t\tsetTimeout(function () {\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\n\t\t\t}, 250);\n\t\t} else {\n\t\t\tupdatePagination();\n\t\t}\n\t}\n\n\tfunction updatePagination() {\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\n\t\t\tapp.parseAndTranslate('partials/paginator', paginationData, function (html) {\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onNewPostInfiniteScroll(data) {\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\n\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isPreviousPostAdded && data.posts[0].selfPost) {\n\t\t\treturn ajaxify.go('post/' + data.posts[0].pid);\n\t\t}\n\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, function (html) {\n\t\t\tif (html) {\n\t\t\t\thtml.addClass('new');\n\t\t\t}\n\t\t\tscrollToPostIfSelf(data.posts[0]);\n\t\t});\n\t}\n\n\tfunction scrollToPostIfSelf(post) {\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\n\t\t\tnavigator.scrollBottom(post.index);\n\t\t}\n\t}\n\n\tfunction createNewPosts(data, repliesSelector, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tif (!data || (data.posts && !data.posts.length)) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tfunction removeAlreadyAddedPosts() {\n\t\t\tvar newPosts = $('[component=\"post\"].new');\n\n\t\t\tif (newPosts.length === data.posts.length) {\n\t\t\t\tvar allSamePids = true;\n\t\t\t\tnewPosts.each(function (index, el) {\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\n\t\t\t\t\t\tallSamePids = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tif (allSamePids) {\n\t\t\t\t\tnewPosts.each(function () {\n\t\t\t\t\t\t$(this).removeClass('new');\n\t\t\t\t\t});\n\t\t\t\t\tdata.posts.length = 0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newPosts.length && data.posts.length > 1) {\n\t\t\t\tdata.posts.forEach(function (post) {\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\n\t\t\t\t\tif (p.hasClass('new')) {\n\t\t\t\t\t\tp.remove();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdata.posts = data.posts.filter(function (post) {\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\n\t\t\t});\n\t\t}\n\n\t\tremoveAlreadyAddedPosts();\n\n\t\tif (!data.posts.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\n\t\tif (direction > 0 && repliesSelector.length) {\n\t\t\tafter = repliesSelector.last();\n\t\t} else if (direction < 0 && repliesSelector.length) {\n\t\t\tbefore = repliesSelector.first();\n\t\t}\n\n\t\tdata.slug = ajaxify.data.slug;\n\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\n\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\n\t\t\thtml = html.filter(function () {\n\t\t\t\tvar pid = $(this).attr('data-pid');\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\n\t\t\t});\n\n\t\t\tif (after) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before) {\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\tcomponents.get('topic').append(html);\n\t\t\t}\n\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, Math.max(20, config.postsPerPage * 2));\n\n\t\t\t$(window).trigger('action:posts.loaded', { posts: data.posts });\n\n\t\t\tPosts.onNewPostsAddedToDom(html);\n\n\t\t\tcallback(html);\n\t\t});\n\t}\n\n\tPosts.loadMorePosts = function (direction) {\n\t\tif (!components.get('topic').length || navigator.scrollActive) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar replies = components.get('topic').find(components.get('post').not('[data-index=0]').not('.new'));\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\n\n\t\tvar tid = ajaxify.data.tid;\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar indicatorEl = $('.loading-indicator');\n\t\tif (!indicatorEl.is(':animated')) {\n\t\t\tindicatorEl.fadeIn();\n\t\t}\n\n\t\tinfinitescroll.loadMore('topics.loadMore', {\n\t\t\ttid: tid,\n\t\t\tafter: after,\n\t\t\tcount: config.postsPerPage,\n\t\t\tdirection: direction,\n\t\t\ttopicPostSort: config.topicPostSort,\n\t\t}, function (data, done) {\n\t\t\tindicatorEl.fadeOut();\n\n\t\t\tif (data && data.posts && data.posts.length) {\n\t\t\t\tcreateNewPosts(data, replies, direction, done);\n\t\t\t} else {\n\t\t\t\tnavigator.update();\n\t\t\t\tdone();\n\t\t\t}\n\t\t});\n\t};\n\n\tPosts.onTopicPageLoad = function (posts) {\n\t\thandlePrivateUploads(posts);\n\t\timages.wrapImagesInLinks(posts);\n\t\tPosts.showBottomPostBar();\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\n\t\tPosts.addBlockquoteEllipses(posts);\n\t\thidePostToolsForDeletedPosts(posts);\n\t\taddNecroPostMessage();\n\t};\n\n\tfunction addNecroPostMessage() {\n\t\tvar necroThreshold = ajaxify.data.necroThreshold * 24 * 60 * 60 * 1000;\n\t\tif (!necroThreshold || (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest')) {\n\t\t\treturn;\n\t\t}\n\n\t\t$('[component=\"post\"]').each(function () {\n\t\t\tvar post = $(this);\n\t\t\tvar prev = post.prev('[component=\"post\"]');\n\t\t\tif (post.is(':has(.necro-post)') || !prev.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (config.topicPostSort === 'newest_to_oldest' && parseInt(prev.attr('data-index'), 10) === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar diff = post.attr('data-timestamp') - prev.attr('data-timestamp');\n\t\t\tif (Math.abs(diff) >= necroThreshold) {\n\t\t\t\tvar suffixAgo = $.timeago.settings.strings.suffixAgo;\n\t\t\t\tvar prefixAgo = $.timeago.settings.strings.prefixAgo;\n\t\t\t\tvar suffixFromNow = $.timeago.settings.strings.suffixFromNow;\n\t\t\t\tvar prefixFromNow = $.timeago.settings.strings.prefixFromNow;\n\n\t\t\t\t$.timeago.settings.strings.suffixAgo = '';\n\t\t\t\t$.timeago.settings.strings.prefixAgo = '';\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = '';\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = '';\n\n\t\t\t\tvar translationText = (diff > 0 ? '[[topic:timeago_later,' : '[[topic:timeago_earlier,') + $.timeago.inWords(diff) + ']]';\n\n\t\t\t\t$.timeago.settings.strings.suffixAgo = suffixAgo;\n\t\t\t\t$.timeago.settings.strings.prefixAgo = prefixAgo;\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = suffixFromNow;\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = prefixFromNow;\n\t\t\t\tapp.parseAndTranslate('partials/topic/necro-post', { text: translationText }, function (html) {\n\t\t\t\t\thtml.prependTo(post);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction handlePrivateUploads(posts) {\n\t\tif (app.user.uid || !ajaxify.data.privateUploads) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Replace all requests for uploaded images/files with a login link\n\t\tvar loginEl = document.createElement('a');\n\t\tloginEl.className = 'login-required';\n\t\tloginEl.href = config.relative_path + '/login';\n\n\t\ttranslator.translate('[[topic:login-to-view]]', function (translated) {\n\t\t\tloginEl.appendChild(document.createTextNode(translated));\n\t\t\tposts.each(function (idx, postEl) {\n\t\t\t\t$(postEl).find('[component=\"post/content\"] img').each(function (idx, imgEl) {\n\t\t\t\t\timgEl = $(imgEl);\n\t\t\t\t\tif (imgEl.attr('src').startsWith(config.relative_path + config.upload_url)) {\n\t\t\t\t\t\timgEl.replaceWith(loginEl.cloneNode(true));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tPosts.onNewPostsAddedToDom = function (posts) {\n\t\tPosts.onTopicPageLoad(posts);\n\n\t\tapp.createUserTooltips(posts);\n\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\n\t\tposts.find('.timeago').timeago();\n\t};\n\n\tPosts.showBottomPostBar = function () {\n\t\tvar mainPost = components.get('post', 'index', 0);\n\t\tvar placeHolder = $('.post-bar-placeholder');\n\t\tvar posts = $('[component=\"post\"]');\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\n\t\t\tplaceHolder.remove();\n\t\t} else if (mainPost.length && posts.length < 2) {\n\t\t\tmainPost.find('.post-bar').remove();\n\t\t}\n\t};\n\n\tfunction hidePostToolsForDeletedPosts(posts) {\n\t\tposts.each(function () {\n\t\t\tif ($(this).hasClass('deleted')) {\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\n\t\t\t}\n\t\t});\n\t}\n\n\tPosts.addBlockquoteEllipses = function (posts) {\n\t\tvar blockquotes = posts.find('[component=\"post/content\"] > blockquote > blockquote');\n\t\tblockquotes.each(function () {\n\t\t\tvar $this = $(this);\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\n\t\t\t}\n\t\t});\n\t};\n\n\treturn Posts;\n});\n"]}