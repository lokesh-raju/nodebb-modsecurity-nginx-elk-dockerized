{"version":3,"sources":["public/src/client/topic/replies.js"],"names":["define","navigator","components","posts","Replies","init","button","post","closest","pid","data","open","find","loading","close","is","addClass","removeClass","socket","emit","err","app","alertError","message","modifyPostsByPrivileges","tplData","privileges","ajaxify","downvote:disabled","reputation:disabled","loggedIn","user","uid","hideReplies","config","hasOwnProperty","showNestedReplies","parseAndTranslate","html","$","component","hide","insertAfter","slideDown","onNewPostsAddedToDom","window","trigger","slideUp","this","remove","onNewPost","incrementCount","replies","toPid","first","length","append","onPostPurged","inc","replyCount","countEl","avatars","count","Math","max","parseInt","attr","timestamp","timestampISO","toggleClass","translateText","users","prepend","timeago"],"mappings":"AAAA,aAGAA,OAAO,uBAAwB,YAAa,aAAc,qBAAsB,SAAUC,EAAWC,EAAYC,GAChH,IAAIC,KAEJA,EAAQC,KAAO,SAAUC,GACxB,IAAIC,EAAOD,EAAOE,QAAQ,cAC1B,IAAIC,EAAMF,EAAKG,KAAK,OACpB,IAAIC,EAAOL,EAAOM,KAAK,mCACvB,IAAIC,EAAUP,EAAOM,KAAK,sCAC1B,IAAIE,EAAQR,EAAOM,KAAK,oCAExB,GAAID,EAAKI,GAAG,kBAAoBF,EAAQE,GAAG,WAAY,CACtDJ,EAAKK,SAAS,UACdH,EAAQI,YAAY,UAEpBC,OAAOC,KAAK,mBAAoBV,EAAK,SAAUW,EAAKV,GACnDG,EAAQG,SAAS,UACjB,GAAII,EAAK,CACRT,EAAKM,YAAY,UACjB,OAAOI,IAAIC,WAAWF,EAAIG,SAG3BT,EAAMG,YAAY,UAElBd,EAAMqB,wBAAwBd,GAC9B,IAAIe,GACHtB,MAAOO,EACPgB,WAAYC,QAAQjB,KAAKgB,WACzBE,oBAAqBD,QAAQjB,KAAK,qBAClCmB,sBAAuBF,QAAQjB,KAAK,uBACpCoB,WAAYT,IAAIU,KAAKC,IACrBC,YAAaC,OAAOC,eAAe,sBAAwBD,OAAOE,kBAAoB,MAEvFf,IAAIgB,kBAAkB,QAAS,QAASZ,EAAS,SAAUa,GAC1DC,EAAE,SAAWC,UAAW,iBAAkBF,KAAKA,GAAMG,OAAOC,YAAYpC,GACtEqC,UAAU,QACZxC,EAAMyC,qBAAqBN,GAC3BC,EAAEM,QAAQC,QAAQ,uBAAyB3C,MAAOO,aAG9C,GAAII,EAAMC,GAAG,iBAAkB,CACrCD,EAAME,SAAS,UACfL,EAAKM,YAAY,UACjBJ,EAAQG,SAAS,UACjBT,EAAKK,KAAK,8BAA8BmC,QAAQ,OAAQ,WACvDR,EAAES,MAAMC,aAKX7C,EAAQ8C,UAAY,SAAUxC,GAC7B,IAAIH,EAAOG,EAAKP,MAAM,GACtB,IAAKI,EAAM,CACV,OAED4C,EAAe5C,EAAM,GACrBG,EAAKuB,YAAcC,OAAOC,eAAe,sBAAwBD,OAAOE,kBAAoB,KAC5Ff,IAAIgB,kBAAkB,QAAS,QAAS3B,EAAM,SAAU4B,GACvD,IAAIc,EAAUb,EAAE,gCAAkChC,EAAK8C,MAAQ,iCAAiCC,QAChG,GAAIF,EAAQG,OAAQ,CACnBH,EAAQI,OAAOlB,GACfnC,EAAMyC,qBAAqBN,OAK9BlC,EAAQqD,aAAe,SAAUlD,GAChC4C,EAAe5C,GAAO,IAGvB,SAAS4C,EAAe5C,EAAMmD,GAC7B,IAAIC,EAAapB,EAAE,gCAAkChC,EAAK8C,MAAQ,MAAMzC,KAAK,kCAAkC0C,QAC/G,IAAIM,EAAUD,EAAW/C,KAAK,uCAC9B,IAAIiD,EAAUF,EAAW/C,KAAK,0CAC9B,IAAIkD,EAAQC,KAAKC,IAAI,EAAGC,SAASL,EAAQM,KAAK,gBAAiB,IAAMR,GACrE,IAAIS,EAAYR,EAAW/C,KAAK,YAAYsD,KAAK,QAAS3D,EAAK6D,cAE/DR,EAAQM,KAAK,eAAgBJ,GAC7BH,EAAWU,YAAY,SAAUP,GAAS,GAC1C,GAAIA,EAAQ,EAAG,CACdF,EAAQU,cAAc,iCAAmCR,EAAQ,UAC3D,CACNF,EAAQU,cAAc,oCAGvB,IAAKT,EAAQjD,KAAK,cAAgBL,EAAKyB,IAAM,MAAMuB,QAAUO,EAAQ,EAAG,CACvEzC,IAAIgB,kBAAkB,QAAS,SAAWlC,QAAUiD,SAAWmB,OAAQhE,EAAKwB,UAAc,SAAUO,GACnGuB,EAAQW,QAAQlC,EAAK1B,KAAK,wEAI5BiD,EAAQ7C,SAAS,WAEjBmD,EAAUzD,KAAK,UAAW,MAAM+D,UAGjC,OAAOrE","file":"public/src/client/topic/replies.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/replies', ['navigator', 'components', 'forum/topic/posts'], function (navigator, components, posts) {\n\tvar Replies = {};\n\n\tReplies.init = function (button) {\n\t\tvar post = button.closest('[data-pid]');\n\t\tvar pid = post.data('pid');\n\t\tvar open = button.find('[component=\"post/replies/open\"]');\n\t\tvar loading = button.find('[component=\"post/replies/loading\"]');\n\t\tvar close = button.find('[component=\"post/replies/close\"]');\n\n\t\tif (open.is(':not(.hidden)') && loading.is('.hidden')) {\n\t\t\topen.addClass('hidden');\n\t\t\tloading.removeClass('hidden');\n\n\t\t\tsocket.emit('posts.getReplies', pid, function (err, data) {\n\t\t\t\tloading.addClass('hidden');\n\t\t\t\tif (err) {\n\t\t\t\t\topen.removeClass('hidden');\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tclose.removeClass('hidden');\n\n\t\t\t\tposts.modifyPostsByPrivileges(data);\n\t\t\t\tvar tplData = {\n\t\t\t\t\tposts: data,\n\t\t\t\t\tprivileges: ajaxify.data.privileges,\n\t\t\t\t\t'downvote:disabled': ajaxify.data['downvote:disabled'],\n\t\t\t\t\t'reputation:disabled': ajaxify.data['reputation:disabled'],\n\t\t\t\t\tloggedIn: !!app.user.uid,\n\t\t\t\t\thideReplies: config.hasOwnProperty('showNestedReplies') ? !config.showNestedReplies : true,\n\t\t\t\t};\n\t\t\t\tapp.parseAndTranslate('topic', 'posts', tplData, function (html) {\n\t\t\t\t\t$('<div>', { component: 'post/replies' }).html(html).hide().insertAfter(button)\n\t\t\t\t\t\t.slideDown('fast');\n\t\t\t\t\tposts.onNewPostsAddedToDom(html);\n\t\t\t\t\t$(window).trigger('action:posts.loaded', { posts: data });\n\t\t\t\t});\n\t\t\t});\n\t\t} else if (close.is(':not(.hidden)')) {\n\t\t\tclose.addClass('hidden');\n\t\t\topen.removeClass('hidden');\n\t\t\tloading.addClass('hidden');\n\t\t\tpost.find('[component=\"post/replies\"]').slideUp('fast', function () {\n\t\t\t\t$(this).remove();\n\t\t\t});\n\t\t}\n\t};\n\n\tReplies.onNewPost = function (data) {\n\t\tvar post = data.posts[0];\n\t\tif (!post) {\n\t\t\treturn;\n\t\t}\n\t\tincrementCount(post, 1);\n\t\tdata.hideReplies = config.hasOwnProperty('showNestedReplies') ? !config.showNestedReplies : true;\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\n\t\t\tvar replies = $('[component=\"post\"][data-pid=\"' + post.toPid + '\"] [component=\"post/replies\"]').first();\n\t\t\tif (replies.length) {\n\t\t\t\treplies.append(html);\n\t\t\t\tposts.onNewPostsAddedToDom(html);\n\t\t\t}\n\t\t});\n\t};\n\n\tReplies.onPostPurged = function (post) {\n\t\tincrementCount(post, -1);\n\t};\n\n\tfunction incrementCount(post, inc) {\n\t\tvar replyCount = $('[component=\"post\"][data-pid=\"' + post.toPid + '\"]').find('[component=\"post/reply-count\"]').first();\n\t\tvar countEl = replyCount.find('[component=\"post/reply-count/text\"]');\n\t\tvar avatars = replyCount.find('[component=\"post/reply-count/avatars\"]');\n\t\tvar count = Math.max(0, parseInt(countEl.attr('data-replies'), 10) + inc);\n\t\tvar timestamp = replyCount.find('.timeago').attr('title', post.timestampISO);\n\n\t\tcountEl.attr('data-replies', count);\n\t\treplyCount.toggleClass('hidden', count <= 0);\n\t\tif (count > 1) {\n\t\t\tcountEl.translateText('[[topic:replies_to_this_post, ' + count + ']]');\n\t\t} else {\n\t\t\tcountEl.translateText('[[topic:one_reply_to_this_post]]');\n\t\t}\n\n\t\tif (!avatars.find('[data-uid=\"' + post.uid + '\"]').length && count < 7) {\n\t\t\tapp.parseAndTranslate('topic', 'posts', { posts: [{ replies: { users: [post.user] } }] }, function (html) {\n\t\t\t\tavatars.prepend(html.find('[component=\"post/reply-count/avatars\"] [component=\"user/picture\"]'));\n\t\t\t});\n\t\t}\n\n\t\tavatars.addClass('hasMore');\n\n\t\ttimestamp.data('timeago', null).timeago();\n\t}\n\n\treturn Replies;\n});\n"]}