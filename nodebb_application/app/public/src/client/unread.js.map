{"version":3,"sources":["public/src/client/unread.js"],"names":["define","topicSelect","components","topicList","Unread","watchStates","ignoring","notwatching","watching","init","app","enterRoom","updateUnreadTopicCount","ajaxify","data","selectedFilter","url","topicCount","$","on","tids","getSelectedTids","length","socket","emit","err","alertError","message","doneRemovingTids","alertSuccess","empty","addClass","removeClass","getCategoryTids","cid","get","each","push","this","attr","removeTids","children","i","remove","count","utils","isNumber","config","relative_path","toggleClass","initUnreadTopics","unreadTopics","user","unreadData","onNewPost","posts","post","parseInt","uid","topic","isFollowing","categoryWatchState","tid","new","watched","unreplied","markTopicsUnread","increaseUnreadCount","isNewTopic","isMain","isUnreplied","postcount","filter","unreadUrl","newCount","window","template","forEach","removeListener","updateUnreadCounters","unreadTopicCount","unreadNewTopicCount","unreadWatchedTopicCount","unreadUnrepliedTopicCount"],"mappings":"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","file":"public/src/client/unread.js","sourcesContent":["'use strict';\n\n\ndefine('forum/unread', ['topicSelect', 'components', 'topicList'], function (topicSelect, components, topicList) {\n\tvar Unread = {};\n\n\tvar watchStates = {\n\t\tignoring: 1,\n\t\tnotwatching: 2,\n\t\twatching: 3,\n\t};\n\n\tUnread.init = function () {\n\t\tapp.enterRoom('unread_topics');\n\n\t\ttopicList.init('unread');\n\n\t\tupdateUnreadTopicCount('/' + ajaxify.data.selectedFilter.url, ajaxify.data.topicCount);\n\n\t\t$('#markSelectedRead').on('click', function () {\n\t\t\tvar tids = topicSelect.getSelectedTids();\n\t\t\tif (!tids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('topics.markAsRead', tids, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\n\t\t$('#markAllRead').on('click', function () {\n\t\t\tsocket.emit('topics.markAllRead', function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\t\t\t\t$('[component=\"pagination\"]').addClass('hidden');\n\t\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t\t$('.markread').addClass('hidden');\n\t\t\t});\n\t\t});\n\n\t\t$('.markread').on('click', '.category', function () {\n\t\t\tfunction getCategoryTids(cid) {\n\t\t\t\tvar tids = [];\n\t\t\t\tcomponents.get('category/topic', 'cid', cid).each(function () {\n\t\t\t\t\ttids.push($(this).attr('data-tid'));\n\t\t\t\t});\n\t\t\t\treturn tids;\n\t\t\t}\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tvar tids = getCategoryTids(cid);\n\n\t\t\tsocket.emit('topics.markCategoryTopicsRead', cid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction doneRemovingTids(tids) {\n\t\tremoveTids(tids);\n\n\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\tif (!$('[component=\"category\"]').children().length) {\n\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t$('.markread').addClass('hidden');\n\t\t}\n\t}\n\n\tfunction removeTids(tids) {\n\t\tfor (var i = 0; i < tids.length; i += 1) {\n\t\t\tcomponents.get('category/topic', 'tid', tids[i]).remove();\n\t\t}\n\t}\n\n\tfunction updateUnreadTopicCount(url, count) {\n\t\tif (!utils.isNumber(count)) {\n\t\t\treturn;\n\t\t}\n\n\t\t$('a[href=\"' + config.relative_path + url + '\"].navigation-link i')\n\t\t\t.toggleClass('unread-count', count > 0)\n\t\t\t.attr('data-content', count > 99 ? '99+' : count);\n\t}\n\n\tUnread.initUnreadTopics = function () {\n\t\tvar unreadTopics = app.user.unreadData;\n\n\t\tfunction onNewPost(data) {\n\t\t\tif (data && data.posts && data.posts.length) {\n\t\t\t\tvar post = data.posts[0];\n\t\t\t\tif (parseInt(post.uid, 10) === parseInt(app.user.uid, 10) ||\n\t\t\t\t\t(!post.topic.isFollowing && post.categoryWatchState !== watchStates.watching)\n\t\t\t\t) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar tid = post.topic.tid;\n\t\t\t\tif (!unreadTopics[''][tid] || !unreadTopics.new[tid] ||\n\t\t\t\t\t!unreadTopics.watched[tid] || !unreadTopics.unreplied[tid]) {\n\t\t\t\t\tmarkTopicsUnread(tid);\n\t\t\t\t}\n\n\t\t\t\tif (!unreadTopics[''][tid]) {\n\t\t\t\t\tincreaseUnreadCount('');\n\t\t\t\t\tunreadTopics[''][tid] = true;\n\t\t\t\t}\n\t\t\t\tvar isNewTopic = post.isMain && parseInt(post.uid, 10) !== parseInt(app.user.uid, 10);\n\t\t\t\tif (isNewTopic && !unreadTopics.new[tid]) {\n\t\t\t\t\tincreaseUnreadCount('new');\n\t\t\t\t\tunreadTopics.new[tid] = true;\n\t\t\t\t}\n\t\t\t\tvar isUnreplied = parseInt(post.topic.postcount, 10) <= 1;\n\t\t\t\tif (isUnreplied && !unreadTopics.unreplied[tid]) {\n\t\t\t\t\tincreaseUnreadCount('unreplied');\n\t\t\t\t\tunreadTopics.unreplied[tid] = true;\n\t\t\t\t}\n\n\t\t\t\tif (post.topic.isFollowing && !unreadTopics.watched[tid]) {\n\t\t\t\t\tincreaseUnreadCount('watched');\n\t\t\t\t\tunreadTopics.watched[tid] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction increaseUnreadCount(filter) {\n\t\t\tvar unreadUrl = '/unread' + (filter ? '?filter=' + filter : '');\n\t\t\tvar newCount = 1 + parseInt($('a[href=\"' + config.relative_path + unreadUrl + '\"].navigation-link i').attr('data-content'), 10);\n\t\t\tupdateUnreadTopicCount(unreadUrl, newCount);\n\t\t}\n\n\t\tfunction markTopicsUnread(tid) {\n\t\t\t$('[data-tid=\"' + tid + '\"]').addClass('unread');\n\t\t}\n\n\t\t$(window).on('action:ajaxify.end', function () {\n\t\t\tif (ajaxify.data.template.topic) {\n\t\t\t\t['', 'new', 'watched', 'unreplied'].forEach(function (filter) {\n\t\t\t\t\tdelete unreadTopics[filter][ajaxify.data.tid];\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t\tsocket.on('event:new_post', onNewPost);\n\n\t\tsocket.removeListener('event:unread.updateCount', updateUnreadCounters);\n\t\tsocket.on('event:unread.updateCount', updateUnreadCounters);\n\t};\n\n\tfunction updateUnreadCounters(data) {\n\t\tupdateUnreadTopicCount('/unread', data.unreadTopicCount);\n\t\tupdateUnreadTopicCount('/unread?filter=new', data.unreadNewTopicCount);\n\t\tupdateUnreadTopicCount('/unread?filter=watched', data.unreadWatchedTopicCount);\n\t\tupdateUnreadTopicCount('/unread?filter=unreplied', data.unreadUnrepliedTopicCount);\n\t}\n\n\treturn Unread;\n});\n"]}