"use strict";define("composer/drafts",function(){var e={};var t;var a=false;e.init=function(a,o){var n=a.find(".draft-icon");function s(){i();t=setTimeout(function(){r(a,n,o)},1e3)}a.on("keyup","textarea, input.handle, input.title",s);a.on("click",'input[type="checkbox"]',s);n.on("animationend",function(){$(this).toggleClass("active",false)});$(window).on("unload",function(t){try{var a=localStorage.getItem("drafts:open");a=JSON.parse(a)||[]}catch(t){console.warn("[composer/drafts] Could not read list of open/available drafts");a=[]}if(a.length){a.forEach(function(t){e.updateVisibility("open",t)})}});e.migrateGuest()};function i(){if(t){clearTimeout(t);t=0}}e.getDraft=function(e){console.warn("[composer/drafts] drafts.getDraft is deprecated! Use drafts.get() instead.");return localStorage.getItem(e)};e.get=function(e){var t=e.split(":")[1];var a=parseInt(t,10)?localStorage:sessionStorage;var i={text:a.getItem(e)};["cid","title","tags"].forEach(function(t){const r=a.getItem(e+":"+t);if(r){i[t]=r}});if(!parseInt(t,10)){i.handle=a.getItem(e+":handle")}$(window).trigger("action:composer.drafts.get",{save_id:e,draft:i,storage:a});return i};function r(t,a,i){if(o(app.user.uid?"localStorage":"sessionStorage")&&i&&i.save_id&&t.length){const o=t.find("input.title");const c=o&&o.val();var r=t.find("textarea").val();var n=app.user.uid?localStorage:sessionStorage;if(i.hasOwnProperty("cid")&&!i.save_id.endsWith(":cid:"+i.cid)){e.removeDraft(i.save_id);i.save_id=i.save_id.replace(/cid:\d+$/,"cid:"+i.cid)}if(r.length||c&&c.length){n.setItem(i.save_id,r);if(i.hasOwnProperty("cid")){const e=t.find("input.tags").val();n.setItem(i.save_id+":tags",e);n.setItem(i.save_id+":title",c)}if(!app.user.uid){var s=t.find("input.handle").val();n.setItem(i.save_id+":handle",s)}$(window).trigger("action:composer.drafts.save",{storage:n,postData:i,postContainer:t});a.toggleClass("active",true)}else{e.removeDraft(i.save_id)}}}e.removeDraft=function(t){if(!t){return}i();e.updateVisibility("available",t);e.updateVisibility("open",t);const a=Object.keys(localStorage).filter(e=>e.startsWith(t));a.forEach(e=>localStorage.removeItem(e));return};e.updateVisibility=function(e,t,a){if(!o(app.user.uid?"localStorage":"sessionStorage")||!t){return}try{var i=localStorage.getItem("drafts:"+e);i=i?JSON.parse(i):[]}catch(e){console.warn("[composer/drafts] Could not read list of open drafts");var i=[]}var r=i.indexOf(t);if(a&&r===-1){i.push(t)}else if(!a&&r!==-1){i.splice(r,1)}localStorage.setItem("drafts:"+e,JSON.stringify(i))};e.migrateGuest=function(){if(o("localStorage")&&app.user.uid){var t=/^composer:\d+:\w+:\d+(:\w+)?$/;var a=Object.keys(sessionStorage).filter(function(e){return t.test(e)});var i=new Set([]);var r=a.map(function(e){var t=e.split(":");t[1]=app.user.uid;i.add(t.slice(0,4).join(":"));return t.join(":")});a.forEach(function(e,t){localStorage.setItem(r[t],sessionStorage.getItem(e));sessionStorage.removeItem(e)});i.forEach(function(t){e.updateVisibility("available",t,1)});return i}};e.loadOpen=function(){try{var t=localStorage.getItem("drafts:available");var a=localStorage.getItem("drafts:open");t=JSON.parse(t)||[];a=JSON.parse(a)||[]}catch(e){console.warn("[composer/drafts] Could not read list of open/available drafts");t=[];a=[]}if(t.length&&app.user&&app.user.uid!==0){require(["composer"],function(i){t.forEach(function(t){if(!t){return}var r=t.split(":");var o=r[1];var n=r[2];var s=r[3];var c=e.get(t);if(a.indexOf(t)!==-1){return}if(parseInt(app.user.uid,10)!==parseInt(o,10)){return}if(!c||c.text&&c.title&&!c.text.title&&!c.text.length){e.updateVisibility("available",t);e.updateVisibility("open",t);return}if(n==="cid"){i.newTopic({cid:s,title:c.title,body:c.text,tags:[]})}else if(n==="tid"){socket.emit("topics.getTopic",s,function(e,t){i.newReply(s,undefined,t.title,content.text)})}else if(n==="pid"){i.editPost(s)}})})}};function o(e){var t;try{t=window[e];var a="__storage_test__";t.setItem(a,a);t.removeItem(a);return true}catch(e){return e instanceof DOMException&&(e.code===22||e.code===1014||e.name==="QuotaExceededError"||e.name==="NS_ERROR_DOM_QUOTA_REACHED")&&(t&&t.length!==0)}}return e});
//# sourceMappingURL=drafts.js.map