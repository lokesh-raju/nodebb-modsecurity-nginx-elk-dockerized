{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js"],"names":["define","tags","tagsinputEl","minTags","maxTags","init","postContainer","postData","tagEl","find","length","ajaxify","data","hasOwnProperty","config","minimumTagsPerTopic","maximumTagsPerTopic","tagsinput","confirmKeys","trimValue","on","event","reachedMaxTags","getTags","attr","cleanTag","utils","cleanUpTag","item","maximumTagLength","different","cancel","minimumTagLength","app","alertError","cid","socket","emit","tag","err","allowed","message","$","window","trigger","addTags","input","toggleTagInput","loadJQueryUI","autocomplete","delay","position","my","at","collision","appendTo","open","this","css","source","request","response","query","term","select","ui","triggerEnter","isEnoughTags","post_uuid","minTagCount","onChangeCategory","get","relative_path","tagDropdown","toggleClass","tagWhitelist","parseAndTranslate","html","slice","forEach","indexOf","removeAttr","privileges","tagsInput","e","jQuery","Event","which","keyCode","setTimeout","i"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js","sourcesContent":["\r\n'use strict';\r\n\r\n/*globals ajaxify, define, config, socket, app, utils*/\r\n\r\ndefine('composer/tags', function() {\r\n\tvar tags = {};\r\n\r\n\tvar tagsinputEl;\r\n\tvar minTags;\r\n\tvar maxTags;\r\n\r\n\ttags.init = function(postContainer, postData) {\r\n\t\tvar tagEl = postContainer.find('.tags');\r\n\t\tif (!tagEl.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tminTags = ajaxify.data.hasOwnProperty('minTags') ? ajaxify.data.minTags : config.minimumTagsPerTopic;\r\n\t\tmaxTags = ajaxify.data.hasOwnProperty('maxTags') ? ajaxify.data.maxTags : config.maximumTagsPerTopic;\r\n\r\n\t\tvar tagsinput = tagEl.tagsinput({\r\n\t\t\tconfirmKeys: [13, 44],\r\n\t\t\ttrimValue: true\r\n\t\t});\r\n\t\ttagsinputEl = tagsinput[0];\r\n\r\n\t\ttagEl.on('beforeItemAdd', function(event) {\r\n\t\t\tvar reachedMaxTags = maxTags && maxTags <= tags.getTags(postContainer.attr('data-uuid')).length;\r\n\t\t\tvar cleanTag = utils.cleanUpTag(event.item, config.maximumTagLength);\r\n\t\t\tvar different = cleanTag !== event.item;\r\n\t\t\tevent.cancel = different ||\r\n\t\t\t\tevent.item.length < config.minimumTagLength ||\r\n\t\t\t\tevent.item.length > config.maximumTagLength ||\r\n\t\t\t\treachedMaxTags;\r\n\r\n\t\t\tif (event.item.length < config.minimumTagLength) {\r\n\t\t\t\treturn app.alertError('[[error:tag-too-short, ' + config.minimumTagLength + ']]');\r\n\t\t\t} else if (event.item.length > config.maximumTagLength) {\r\n\t\t\t\treturn app.alertError('[[error:tag-too-long, ' + config.maximumTagLength + ']]');\r\n\t\t\t} else if (reachedMaxTags) {\r\n\t\t\t\treturn app.alertError('[[error:too-many-tags, ' + maxTags + ']]');\r\n\t\t\t}\r\n\t\t\tif (different) {\r\n\t\t\t\ttagEl.tagsinput('add', cleanTag);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\ttagEl.on('itemAdded', function(event) {\r\n\t\t\tvar cid = postData.hasOwnProperty('cid') ? postData.cid : ajaxify.data.cid;\r\n\t\t\tsocket.emit('topics.isTagAllowed', { tag: event.item, cid: cid || 0 }, function(err, allowed) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tif (!allowed) {\r\n\t\t\t\t\treturn tagEl.tagsinput('remove', event.item);\r\n\t\t\t\t}\r\n\t\t\t\t$(window).trigger('action:tag.added', { cid: cid, tagEl: tagEl, tag: event.item });\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\taddTags(postData.tags, tagEl);\r\n\r\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\r\n\t\ttoggleTagInput(postContainer, postData, ajaxify.data);\r\n\r\n\t\tapp.loadJQueryUI(function() {\r\n\t\t\tinput.autocomplete({\r\n\t\t\t\tdelay: 100,\r\n\t\t\t\tposition: { my: \"left bottom\", at: \"left top\", collision: \"flip\" },\r\n\t\t\t\tappendTo: postContainer.find('.bootstrap-tagsinput'),\r\n\t\t\t\topen: function() {\r\n\t\t\t\t\t$(this).autocomplete('widget').css('z-index', 20000);\r\n\t\t\t\t},\r\n\t\t\t\tsource: function(request, response) {\r\n\t\t\t\t\tsocket.emit('topics.autocompleteTags', {query: request.term, cid: postData.cid}, function(err, tags) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (tags) {\r\n\t\t\t\t\t\t\tresponse(tags);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t$('.ui-autocomplete a').attr('data-ajaxify', 'false');\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tselect: function(event, ui) {\r\n\t\t\t\t\t// when autocomplete is selected from the dropdown simulate a enter key down to turn it into a tag\r\n\t\t\t\t\ttriggerEnter(input);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tinput.attr('tabIndex', tagEl.attr('tabIndex'));\r\n\t\tinput.on('blur', function() {\r\n\t\t\ttriggerEnter(input);\r\n\t\t});\r\n\r\n\t\t$('[component=\"composer/tag/dropdown\"]').on('click', 'li', function () {\r\n\t\t\tvar tag = $(this).attr('data-tag');\r\n\t\t\tif (tag) {\r\n\t\t\t\taddTags([tag], tagEl);\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t});\r\n\t};\r\n\r\n\ttags.isEnoughTags = function (post_uuid) {\r\n\t\treturn tags.getTags(post_uuid).length >= minTags;\r\n\t};\r\n\r\n\ttags.minTagCount = function () {\r\n\t\treturn minTags;\r\n\t};\r\n\r\n\ttags.onChangeCategory = function (postContainer, postData, cid) {\r\n\t\t$.get(config.relative_path + '/api/category/' + cid, function (data) {\r\n\t\t\tvar tagDropdown = postContainer.find('[component=\"composer/tag/dropdown\"]');\r\n\t\t\tif (!tagDropdown.length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttoggleTagInput(postContainer, postData, data);\r\n\t\t\ttagDropdown.toggleClass('hidden', !data.tagWhitelist || !data.tagWhitelist.length);\r\n\t\t\tif (data.tagWhitelist) {\r\n\t\t\t\tapp.parseAndTranslate('composer', 'tagWhitelist', { tagWhitelist: data.tagWhitelist }, function (html) {\r\n\t\t\t\t\ttagDropdown.find('.dropdown-menu').html(html);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tfunction toggleTagInput(postContainer, postData, data) {\r\n\t\tvar tagEl = postContainer.find('.tags');\r\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\r\n\t\tif (!input.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (data.hasOwnProperty('minTags')) {\r\n\t\t\tminTags = data.minTags;\r\n\t\t}\r\n\t\tif (data.hasOwnProperty('maxTags')) {\r\n\t\t\tmaxTags = data.maxTags;\r\n\t\t}\r\n\r\n\t\tif (data.tagWhitelist && data.tagWhitelist.length) {\r\n\t\t\tinput.attr('readonly', '');\r\n\t\t\tinput.attr('placeholder', '');\r\n\r\n\t\t\ttagEl.tagsinput('items').slice().forEach(function (tag) {\r\n\t\t\t\tif (data.tagWhitelist.indexOf(tag) === -1) {\r\n\t\t\t\t\ttagEl.tagsinput('remove', tag);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tinput.removeAttr('readonly');\r\n\t\t\tinput.attr('placeholder', postContainer.find('input.tags').attr('placeholder'));\r\n\t\t}\r\n\r\n\t\tpostContainer.find('.tags-container').toggleClass('hidden', (\r\n\t\t\tdata.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) ||\r\n\t\t\t(maxTags === 0 && !postData.tags.length)\r\n\t\t);\r\n\r\n\t\tif (data.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) {\r\n\t\t\ttagEl.tagsinput('removeAll');\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:tag.toggleInput', {\r\n\t\t\tpostContainer: postContainer,\r\n\t\t\ttagWhitelist: data.tagWhitelist,\r\n\t\t\ttagsInput: input,\r\n\t\t});\r\n\t}\r\n\r\n\tfunction triggerEnter(input) {\r\n\t\t// http://stackoverflow.com/a/3276819/583363\r\n\t\tvar e = jQuery.Event('keypress');\r\n\t\te.which = 13;\r\n\t\te.keyCode = 13;\r\n\t\tsetTimeout(function() {\r\n\t\t\tinput.trigger(e);\r\n\t\t}, 100);\r\n\t}\r\n\r\n\tfunction addTags(tags, tagEl) {\r\n\t\tif (tags && tags.length) {\r\n\t\t\tfor (var i=0; i<tags.length; ++i) {\r\n\t\t\t\ttagEl.tagsinput('add', tags[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttags.getTags = function(post_uuid) {\r\n\t\treturn $('.composer[data-uuid=\"' + post_uuid + '\"]' + ' .tags').tagsinput('items');\r\n\t};\r\n\r\n\treturn tags;\r\n});\r\n"]}