{"version":3,"sources":["public/src/modules/handleBack.js"],"names":["define","components","storage","navigator","pagination","handleBack","loadTopicsMethod","init","_loadTopicsMethod","saveClickedIndex","$","window","off","onBackClicked","on","clickedIndex","this","parents","attr","windowScrollTop","scrollTop","each","index","el","offset","top","setItem","ajaxify","data","template","category","recent","bookmarkIndex","getItem","removeItem","utils","isNumber","Math","max","parseInt","config","usePagination","page","ceil","topicsPerPage","currentPage","loadPage","scrollToTopic","empty","highlightTopic","topicIndex","highlight","get","length","hasClass","addClass","setTimeout","removeClass","scrollTo","update"],"mappings":"AAAA,aAEAA,OAAO,cACN,aACA,UACA,YACA,oBACE,SAAUC,EAAYC,EAASC,EAAWC,GAC5C,IAAIC,KACJ,IAAIC,EAEJD,EAAWE,KAAO,SAAUC,GAC3BF,EAAmBE,EACnBC,IACAC,EAAEC,QAAQC,IAAI,kBAAmBC,GAAeC,GAAG,kBAAmBD,IAGvE,SAASJ,IACRC,EAAE,0BAA0BI,GAAG,QAAS,6BAA8B,WACrE,IAAIC,EAAeL,EAAEM,MAAMC,QAAQ,gBAAgBC,KAAK,cACxD,IAAIC,EAAkBT,EAAEC,QAAQS,YAChCV,EAAE,gCAAgCW,KAAK,SAAUC,EAAOC,GACvD,GAAIb,EAAEa,GAAIC,SAASC,IAAMN,EAAkB,EAAG,CAC7CjB,EAAQwB,QAAQ,oBAAqBhB,EAAEa,GAAIL,KAAK,eAChDhB,EAAQwB,QAAQ,4BAA6BX,GAC7Cb,EAAQwB,QAAQ,2BAA4BhB,EAAEa,GAAIC,SAASC,IAAMN,GACjE,OAAO,WAMX,SAASN,IACR,GAAKc,QAAQC,KAAKC,SAASC,UAAYH,QAAQC,KAAKC,SAASE,OAAS,CACrE,IAAIC,EAAgB9B,EAAQ+B,QAAQ,qBACpC,IAAIlB,EAAeb,EAAQ+B,QAAQ,6BAEnC/B,EAAQgC,WAAW,qBACnBhC,EAAQgC,WAAW,6BACnB,IAAKC,MAAMC,SAASJ,GAAgB,CACnC,OAGDA,EAAgBK,KAAKC,IAAI,EAAGC,SAASP,EAAe,KAAO,GAC3DjB,EAAesB,KAAKC,IAAI,EAAGC,SAASxB,EAAc,KAAO,GAEzD,GAAIyB,OAAOC,cAAe,CACzB,IAAIC,EAAOL,KAAKM,MAAMJ,SAASP,EAAe,IAAM,GAAKQ,OAAOI,eAChE,GAAIL,SAASG,EAAM,MAAQf,QAAQC,KAAKxB,WAAWyC,YAAa,CAC/DzC,EAAW0C,SAASJ,EAAM,WACzBrC,EAAW0C,cAAcf,EAAejB,SAEnC,CACNV,EAAW0C,cAAcf,EAAejB,QAEnC,CACN,GAAIiB,IAAkB,EAAG,CACxB3B,EAAW0C,cAAcf,EAAejB,GACxC,OAGDL,EAAE,0BAA0BsC,QAC5B1C,EAAiB+B,KAAKC,IAAI,EAAGN,EAAgB,GAAK,EAAG,WACpD3B,EAAW0C,cAAcf,EAAejB,OAM5CV,EAAW4C,eAAiB,SAAUC,GACrC,IAAIC,EAAYlD,EAAWmD,IAAI,iBAAkB,QAASF,GAE1D,GAAIC,EAAUE,SAAWF,EAAUG,SAAS,aAAc,CACzDH,EAAUI,SAAS,aACnBC,WAAW,WACVL,EAAUM,YAAY,cACpB,OAILpD,EAAW0C,cAAgB,SAAUf,EAAejB,GACnD,IAAKoB,MAAMC,SAASJ,GAAgB,CACnC,OAGD,IAAI0B,EAAWzD,EAAWmD,IAAI,iBAAkB,QAASpB,GAEzD,GAAI0B,EAASL,OAAQ,CACpB,IAAI7B,EAAStB,EAAQ+B,QAAQ,4BAC7B/B,EAAQgC,WAAW,4BACnBxB,EAAEC,QAAQS,UAAUsC,EAASlC,SAASC,IAAMD,GAC5CnB,EAAW4C,eAAelC,GAC1BZ,EAAUwD,WAIZ,OAAOtD","file":"public/src/modules/handleBack.js","sourcesContent":["'use strict';\n\ndefine('handleBack', [\n\t'components',\n\t'storage',\n\t'navigator',\n\t'forum/pagination',\n], function (components, storage, navigator, pagination) {\n\tvar handleBack = {};\n\tvar loadTopicsMethod;\n\n\thandleBack.init = function (_loadTopicsMethod) {\n\t\tloadTopicsMethod = _loadTopicsMethod;\n\t\tsaveClickedIndex();\n\t\t$(window).off('action:popstate', onBackClicked).on('action:popstate', onBackClicked);\n\t};\n\n\tfunction saveClickedIndex() {\n\t\t$('[component=\"category\"]').on('click', '[component=\"topic/header\"]', function () {\n\t\t\tvar clickedIndex = $(this).parents('[data-index]').attr('data-index');\n\t\t\tvar windowScrollTop = $(window).scrollTop();\n\t\t\t$('[component=\"category/topic\"]').each(function (index, el) {\n\t\t\t\tif ($(el).offset().top - windowScrollTop > 0) {\n\t\t\t\t\tstorage.setItem('category:bookmark', $(el).attr('data-index'));\n\t\t\t\t\tstorage.setItem('category:bookmark:clicked', clickedIndex);\n\t\t\t\t\tstorage.setItem('category:bookmark:offset', $(el).offset().top - windowScrollTop);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onBackClicked() {\n\t\tif ((ajaxify.data.template.category || ajaxify.data.template.recent)) {\n\t\t\tvar bookmarkIndex = storage.getItem('category:bookmark');\n\t\t\tvar clickedIndex = storage.getItem('category:bookmark:clicked');\n\n\t\t\tstorage.removeItem('category:bookmark');\n\t\t\tstorage.removeItem('category:bookmark:clicked');\n\t\t\tif (!utils.isNumber(bookmarkIndex)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tbookmarkIndex = Math.max(0, parseInt(bookmarkIndex, 10) || 0);\n\t\t\tclickedIndex = Math.max(0, parseInt(clickedIndex, 10) || 0);\n\n\t\t\tif (config.usePagination) {\n\t\t\t\tvar page = Math.ceil((parseInt(bookmarkIndex, 10) + 1) / config.topicsPerPage);\n\t\t\t\tif (parseInt(page, 10) !== ajaxify.data.pagination.currentPage) {\n\t\t\t\t\tpagination.loadPage(page, function () {\n\t\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (bookmarkIndex === 0) {\n\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\t\t\t\tloadTopicsMethod(Math.max(0, bookmarkIndex - 1) + 1, function () {\n\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\thandleBack.highlightTopic = function (topicIndex) {\n\t\tvar highlight = components.get('category/topic', 'index', topicIndex);\n\n\t\tif (highlight.length && !highlight.hasClass('highlight')) {\n\t\t\thighlight.addClass('highlight');\n\t\t\tsetTimeout(function () {\n\t\t\t\thighlight.removeClass('highlight');\n\t\t\t}, 5000);\n\t\t}\n\t};\n\n\thandleBack.scrollToTopic = function (bookmarkIndex, clickedIndex) {\n\t\tif (!utils.isNumber(bookmarkIndex)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar scrollTo = components.get('category/topic', 'index', bookmarkIndex);\n\n\t\tif (scrollTo.length) {\n\t\t\tvar offset = storage.getItem('category:bookmark:offset');\n\t\t\tstorage.removeItem('category:bookmark:offset');\n\t\t\t$(window).scrollTop(scrollTo.offset().top - offset);\n\t\t\thandleBack.highlightTopic(clickedIndex);\n\t\t\tnavigator.update();\n\t\t}\n\t};\n\n\treturn handleBack;\n});\n"]}