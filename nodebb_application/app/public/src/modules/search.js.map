{"version":3,"sources":["public/src/modules/search.js"],"names":["define","nav","translator","storage","Search","current","query","data","callback","topicSearch","term","match","ajaxify","go","createQueryString","cleanedTerm","replace","tid","length","queryTopic","api","apiURL","config","relative_path","searchOnly","undefined","searchURL","$","get","result","url","searchIn","in","postedBy","by","encodeURIComponent","e","app","alertError","matchWords","categories","searchChildren","hasTags","parseInt","replies","repliesFilter","timeRange","timeFilter","sortBy","sortDirection","showAs","window","trigger","decodeURIComponent","param","getSearchPreferences","JSON","parse","getItem","socket","emit","err","pids","message","Array","isArray","results","sort","a","b","checkPagePresence","topicDOM","update","active","prev","index","next","topicSearchEl","start","find","html","removeAttr","pid","topicPostSort","postIndex","scrollToIndex","translate","text","removeClass","attr","require","mousetrap","bind","end","addClass","unbind"],"mappings":"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","file":"public/src/modules/search.js","sourcesContent":["'use strict';\n\n\ndefine('search', ['navigator', 'translator', 'storage'], function (nav, translator, storage) {\n\tvar Search = {\n\t\tcurrent: {},\n\t};\n\n\tSearch.query = function (data, callback) {\n\t\t// Detect if a tid was specified\n\t\tvar topicSearch = data.term.match(/^in:topic-([\\d]+) /);\n\t\tcallback = callback || function () {};\n\t\tif (!topicSearch) {\n\t\t\tajaxify.go('search?' + createQueryString(data));\n\t\t\tcallback();\n\t\t} else {\n\t\t\tvar cleanedTerm = data.term.replace(topicSearch[0], '');\n\t\t\tvar tid = topicSearch[1];\n\n\t\t\tif (cleanedTerm.length > 0) {\n\t\t\t\tSearch.queryTopic(tid, cleanedTerm, callback);\n\t\t\t}\n\t\t}\n\t};\n\n\tSearch.api = function (data, callback) {\n\t\tvar apiURL = config.relative_path + '/api/search?' + createQueryString(data);\n\t\tdata.searchOnly = undefined;\n\t\tvar searchURL = config.relative_path + '/search?' + createQueryString(data);\n\t\t$.get(apiURL, function (result) {\n\t\t\tresult.url = searchURL;\n\t\t\tcallback(result);\n\t\t});\n\t};\n\n\tfunction createQueryString(data) {\n\t\tvar searchIn = data.in || 'titlesposts';\n\t\tvar postedBy = data.by || '';\n\t\tvar term = data.term.replace(/^[ ?#]*/, '');\n\t\ttry {\n\t\t\tterm = encodeURIComponent(term);\n\t\t} catch (e) {\n\t\t\treturn app.alertError('[[error:invalid-search-term]]');\n\t\t}\n\n\t\tvar query = {\n\t\t\tterm: term,\n\t\t\tin: searchIn,\n\t\t};\n\n\t\tif (data.matchWords) {\n\t\t\tquery.matchWords = data.matchWords;\n\t\t}\n\n\t\tif (postedBy && postedBy.length && (searchIn === 'posts' || searchIn === 'titles' || searchIn === 'titlesposts')) {\n\t\t\tquery.by = postedBy;\n\t\t}\n\n\t\tif (data.categories && data.categories.length) {\n\t\t\tquery.categories = data.categories;\n\t\t\tif (data.searchChildren) {\n\t\t\t\tquery.searchChildren = data.searchChildren;\n\t\t\t}\n\t\t}\n\n\t\tif (data.hasTags && data.hasTags.length) {\n\t\t\tquery.hasTags = data.hasTags;\n\t\t}\n\n\t\tif (parseInt(data.replies, 10) > 0) {\n\t\t\tquery.replies = data.replies;\n\t\t\tquery.repliesFilter = data.repliesFilter || 'atleast';\n\t\t}\n\n\t\tif (data.timeRange) {\n\t\t\tquery.timeRange = data.timeRange;\n\t\t\tquery.timeFilter = data.timeFilter || 'newer';\n\t\t}\n\n\t\tif (data.sortBy) {\n\t\t\tquery.sortBy = data.sortBy;\n\t\t\tquery.sortDirection = data.sortDirection;\n\t\t}\n\n\t\tif (data.showAs) {\n\t\t\tquery.showAs = data.showAs;\n\t\t}\n\n\t\tif (data.searchOnly) {\n\t\t\tquery.searchOnly = data.searchOnly;\n\t\t}\n\n\t\t$(window).trigger('action:search.createQueryString', {\n\t\t\tquery: query,\n\t\t\tdata: data,\n\t\t});\n\n\t\treturn decodeURIComponent($.param(query));\n\t}\n\n\tSearch.getSearchPreferences = function () {\n\t\ttry {\n\t\t\treturn JSON.parse(storage.getItem('search-preferences') || '{}');\n\t\t} catch (e) {\n\t\t\treturn {};\n\t\t}\n\t};\n\n\tSearch.queryTopic = function (tid, term) {\n\t\tsocket.emit('topics.search', {\n\t\t\ttid: tid,\n\t\t\tterm: term,\n\t\t}, function (err, pids) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (Array.isArray(pids)) {\n\t\t\t\t// Sort pids numerically & store\n\t\t\t\tSearch.current = {\n\t\t\t\t\tresults: pids.sort(function (a, b) {\n\t\t\t\t\t\treturn a - b;\n\t\t\t\t\t}),\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tterm: term,\n\t\t\t\t};\n\n\t\t\t\tSearch.checkPagePresence(tid, function () {\n\t\t\t\t\tSearch.topicDOM.update(0);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n\n\tSearch.checkPagePresence = function (tid, callback) {\n\t\tif (parseInt(ajaxify.data.tid, 10) !== parseInt(tid, 10)) {\n\t\t\tajaxify.go('topic/' + tid, callback);\n\t\t} else {\n\t\t\tcallback();\n\t\t}\n\t};\n\n\tSearch.topicDOM = {\n\t\tactive: false,\n\t};\n\n\tSearch.topicDOM.prev = function () {\n\t\tSearch.topicDOM.update((Search.current.index === 0) ? Search.current.results.length - 1 : Search.current.index - 1);\n\t};\n\n\tSearch.topicDOM.next = function () {\n\t\tSearch.topicDOM.update((Search.current.index === Search.current.results.length - 1) ? 0 : Search.current.index + 1);\n\t};\n\n\tSearch.topicDOM.update = function (index) {\n\t\tvar topicSearchEl = $('.topic-search');\n\t\tSearch.current.index = index;\n\n\t\tSearch.topicDOM.start();\n\n\t\tif (Search.current.results.length > 0) {\n\t\t\ttopicSearchEl.find('.count').html((index + 1) + ' / ' + Search.current.results.length);\n\t\t\ttopicSearchEl.find('.prev, .next').removeAttr('disabled');\n\t\t\tvar data = {\n\t\t\t\tpid: Search.current.results[index],\n\t\t\t\ttid: Search.current.tid,\n\t\t\t\ttopicPostSort: config.topicPostSort,\n\t\t\t};\n\t\t\tsocket.emit('posts.getPidIndex', data, function (err, postIndex) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tnav.scrollToIndex(postIndex, true);\n\t\t\t});\n\t\t} else {\n\t\t\ttranslator.translate('[[search:no-matches]]', function (text) {\n\t\t\t\ttopicSearchEl.find('.count').html(text);\n\t\t\t});\n\t\t\ttopicSearchEl.removeClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\t}\n\t};\n\n\tSearch.topicDOM.start = function () {\n\t\t$('.topic-search').removeClass('hidden');\n\t\tif (!Search.topicDOM.active) {\n\t\t\tSearch.topicDOM.active = true;\n\n\t\t\t// Bind to esc\n\t\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\t\tmousetrap.bind('esc', Search.topicDOM.end);\n\t\t\t});\n\t\t}\n\t};\n\n\tSearch.topicDOM.end = function () {\n\t\t$('.topic-search').addClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\tSearch.topicDOM.active = false;\n\n\t\t// Unbind esc\n\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\tmousetrap.unbind('esc', Search.topicDOM.end);\n\t\t});\n\t};\n\n\treturn Search;\n});\n"]}